player = {
                "name": random.choice(names),
                "position": position,
                "attack": attack,
                "defense": defense,
                "price": price,
                "country": random.choice(["🇷🇺 Россия", "🇧🇷 Бразилия", "🇦🇷 Аргентина", "🇫🇷 Франция", "🇩🇪 Германия"])
            }
            self.transfer_players.append(player)
    
    def calculate_team_power(self):
        if not self.players:
            return 50
        total_power = sum(p["attack"] + p["defense"] for p in self.players)
        return total_power / len(self.players)
    
    def play_match(self):
        team_power = self.calculate_team_power()
        opponent_index = (self.week - 1) % (len(self.league_teams) - 1)
        opponent = self.league_teams[opponent_index + 1]
        
        opponent_power = 60 + (self.week * 2) + random.randint(-10, 10)
        
        power_diff = team_power - opponent_power
        my_goals = max(0, int(1 + (power_diff / 20) + random.randint(0, 2)))
        opponent_goals = max(0, int(1 + (-power_diff / 20) + random.randint(0, 2)))
        
        self.league_teams[0]["goals_for"] += my_goals
        self.league_teams[0]["goals_against"] += opponent_goals
        opponent["goals_for"] += opponent_goals
        opponent["goals_against"] += my_goals
        
        if my_goals > opponent_goals:
            result = f"ПОБЕДА {my_goals}-{opponent_goals}! 🎉"
            self.points += 3
            self.league_teams[0]["points"] += 3
            prize = 250000
        elif my_goals == opponent_goals:
            result = f"НИЧЬЯ {my_goals}-{opponent_goals} 🤝"
            self.points += 1
            self.league_teams[0]["points"] += 1
            opponent["points"] += 1
            prize = 120000
        else:
            result = f"ПОРАЖЕНИЕ {my_goals}-{opponent_goals} 😔"
            opponent["points"] += 3


@bot.message_handler(commands=['start'])
def start_command(message):
    bot.send_message(message.chat.id,
        "⚽ ФУТБОЛЬНЫЙ МЕНЕДЖЕР ПРО-ЛИГА! 🏆\n\n"
        "🎮 ОСНОВНЫЕ КОМАНДЫ:\n"
        "/team - Моя команда\n"
        "/play - Сыграть матч\n"
        "/table - Таблица лиги\n\n"
        "🛒 ТРАНСФЕРЫ:\n"
        "/market - Трансферный рынок\n"
        "/buy [N] - Купить игрока\n"
        "/sell [N] - Продать игрока\n"
        "/refresh - Обновить рынок\n\n"
        "💼 ФИНАНСЫ:\n"
        "/money - Бюджет\n"
        "/points - Статистика"
    )

@bot.message_handler(commands=['play'])
def play_match(message):
    bot.send_message(message.chat.id, game.play_match())

@bot.message_handler(commands=['team'])
def show_team(message):
    team_info = f"🏆 Мечтатели FC\n💰 Бюджет: {game.money:,}€\n🏅 Очков: {game.points}\n⭐ Сила: {game.calculate_team_power():.1f}\n\n"
    team_info += "👥 Состав:\n"
    for i, player in enumerate(game.players, 1):
        team_info += f"{i}. {player['name']} ({player['position']})\n"
        team_info += f"   ⚔️{player['attack']} 🛡️{player['defense']} 💰{player['salary']:,}€\n"
    bot.send_message(message.chat.id, team_info)

@bot.message_handler(commands=['table'])
def show_table(message):
    bot.send_message(message.chat.id, game.show_league_table())

@bot.message_handler(commands=['market'])
def show_market(message):
    bot.send_message(message.chat.id, game.show_transfer_market())

@bot.message_handler(commands=['buy'])
def buy_player(message):
    parts = message.text.split()
    if len(parts) == 2:
        bot.send_message(message.chat.id, game.buy_player(parts[1]))
    else:
        bot.send_message(message.chat.id, "Используй: /buy [номер]")

@bot.message_handler(commands=['sell'])
def sell_player(message):
    parts = message.text.split()
    if len(parts) == 2:
        bot.send_message(message.chat.id, game.sell_player(parts[1]))
    else:
        bot.send_message(message.chat.id, "Используй: /sell [номер]")

@bot.message_handler(commands=['refresh'])
def refresh_market(message):
    bot.send_message(message.chat.id, game.refresh_market())

@bot.message_handler(commands=['money', 'points'])
def show_stats(message):
    bot.send_message(message.chat.id, f"💵 Бюджет: {game.money:,}€\n🏅 Очков: {game.points}\n📅 Неделя: {game.week}")

@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
    return 'OK', 200

@app.route('/')
def index():
    return '⚽ Football Manager Bot is running! 🏆'

def set_webhook():
    webhook_url = f"https://{os.environ.get('RENDER_SERVICE_NAME')}.onrender.com/webhook"
    bot.remove_webhook()
    bot.set_webhook(url=webhook_url)
    print(f"Webhook set to: {webhook_url}")

if __name__ == '__main__':
    set_webhook()
    app.run(host='0.0.0.0', port=5000)

            
