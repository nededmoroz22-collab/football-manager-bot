from flask import Flask, request
import os
import telebot
import random
import json
import time
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

BOT_TOKEN = os.environ.get('BOT_TOKEN')
bot = telebot.TeleBot(BOT_TOKEN)
app = Flask(__name__)

# === PvP Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ Ğ¡ Ğ¡ĞĞ¥Ğ ĞĞĞ•ĞĞ˜Ğ•Ğœ ===
class PvPMatch:
    def __init__(self, match_id, challenger_id, opponent_id, bet_amount=0):
        self.match_id = match_id
        self.challenger_id = challenger_id
        self.opponent_id = opponent_id
        self.bet_amount = bet_amount
        self.status = "pending"
        self.score = [0, 0]
        self.winner = None
        self.created_time = time.time()

class RatingSystem:
    def __init__(self):
        self.ratings = {}
    
    def get_rating(self, user_id):
        if user_id not in self.ratings:
            self.ratings[user_id] = {"rating": 1500, "wins": 0, "losses": 0, "draws": 0}
        return self.ratings[user_id]
    
    def update_rating(self, winner_id, loser_id, is_draw=False):
        if is_draw:
            self.ratings[winner_id]["rating"] += 2
            self.ratings[loser_id]["rating"] -= 2
            self.ratings[winner_id]["draws"] += 1
            self.ratings[loser_id]["draws"] += 1
        else:
            rating_diff = self.ratings[loser_id]["rating"] - self.ratings[winner_id]["rating"]
            k = 24
            expected_win = 1 / (1 + 10 ** (rating_diff / 400))
            points = k * (1 - expected_win)
            
            self.ratings[winner_id]["rating"] += points
            self.ratings[loser_id]["rating"] -= points
            self.ratings[winner_id]["wins"] += 1
            self.ratings[loser_id]["losses"] += 1

class PvPManager:
    def __init__(self):
        self.active_matches = {}
        self.pending_requests = {}
        self.rating_system = RatingSystem()
        self.match_counter = 1
        self.load_pvp_data()
    
    def save_pvp_data(self):
        """Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ PvP Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² Ñ„Ğ°Ğ¹Ğ»"""
        # ĞšĞ¾Ğ½Ğ²ĞµÑ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚Ñ‹ PvPMatch Ğ² ÑĞ»Ğ¾Ğ²Ğ°Ñ€Ğ¸ Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ
        matches_data = {}
        for match_id, match in self.active_matches.items():
            matches_data[match_id] = {
                'match_id': match.match_id,
                'challenger_id': match.challenger_id,
                'opponent_id': match.opponent_id,
                'bet_amount': match.bet_amount,
                'status': match.status,
                'score': match.score,
                'winner': match.winner,
                'created_time': match.created_time
            }
        
        pvp_data = {
            'ratings': self.rating_system.ratings,
            'match_counter': self.match_counter,
            'user_usernames': user_usernames,
            'active_matches': matches_data,
            'pending_requests': self.pending_requests
        }
        try:
            with open('/tmp/pvp_data.json', 'w') as f:
                json.dump(pvp_data, f)
        except Exception as e:
            print(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ PvP: {e}")
    
    def load_pvp_data(self):
        """Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµÑ‚ PvP Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ñ„Ğ°Ğ¹Ğ»Ğ°"""
        global user_usernames
        try:
            with open('/tmp/pvp_data.json', 'r') as f:
                pvp_data = json.load(f)
                self.rating_system.ratings = pvp_data.get('ratings', {})
                self.match_counter = pvp_data.get('match_counter', 1)
                user_usernames.update(pvp_data.get('user_usernames', {}))
                
                # Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¼Ğ°Ñ‚Ñ‡Ğ¸
                matches_data = pvp_data.get('active_matches', {})
                for match_id, match_data in matches_data.items():
                    match = PvPMatch(
                        match_data['match_id'],
                        match_data['challenger_id'],
                        match_data['opponent_id'],
                        match_data['bet_amount']
                    )
                    match.status = match_data['status']
                    match.score = match_data['score']
                    match.winner = match_data['winner']
                    match.created_time = match_data['created_time']
                    self.active_matches[match_id] = match
                
                # Ğ’Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ pending_requests
                self.pending_requests = pvp_data.get('pending_requests', {})
                
                print("âœ… PvP Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹")
        except Exception as e:
            print(f"âŒ ĞĞµÑ‚ PvP Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…, Ğ½Ğ¾Ğ²Ğ°Ñ ÑĞµÑÑĞ¸Ñ: {e}")
            self.rating_system.ratings = {}
            self.match_counter = 1
            self.active_matches = {}
            self.pending_requests = {}
    
    def clean_old_matches(self, challenger_id, opponent_id):
        """Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ pending Ğ¼Ğ°Ñ‚Ñ‡Ğ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ñ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²"""
        matches_to_remove = []
        for match_id, match in self.active_matches.items():
            if match.status == "pending" and (
                match.challenger_id == challenger_id or 
                match.challenger_id == opponent_id or
                match.opponent_id == challenger_id or 
                match.opponent_id == opponent_id
            ):
                matches_to_remove.append(match_id)
        
        for match_id in matches_to_remove:
            if match_id in self.active_matches:
                del self.active_matches[match_id]
        
        # Ğ§Ğ¸ÑÑ‚Ğ¸Ğ¼ pending_requests
        if challenger_id in self.pending_requests:
            del self.pending_requests[challenger_id]
        if opponent_id in self.pending_requests:
            del self.pending_requests[opponent_id]
    
    def create_match(self, challenger_id, opponent_id, bet_amount=0):
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ pending Ğ¼Ğ°Ñ‚Ñ‡Ğ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ¸Ñ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
        self.clean_old_matches(challenger_id, opponent_id)
        
        match_id = f"match_{self.match_counter}"
        self.match_counter += 1
        
        match = PvPMatch(match_id, challenger_id, opponent_id, bet_amount)
        self.active_matches[match_id] = match
        self.pending_requests[opponent_id] = match_id
        
        print(f"ğŸ¯ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼Ğ°Ñ‚Ñ‡: {match_id}")
        
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑÑ€Ğ°Ğ·Ñƒ
        self.save_pvp_data()
        return match
    
    def get_match_by_opponent(self, opponent_id):
        match_id = self.pending_requests.get(opponent_id)
        return self.active_matches.get(match_id)
    
    def calculate_pvp_result(self, match):
        challenger_game = get_user_game(match.challenger_id)
        opponent_game = get_user_game(match.opponent_id)
        
        power1 = challenger_game.calculate_team_power()
        power2 = opponent_game.calculate_team_power()
        
        rating1 = self.rating_system.get_rating(match.challenger_id)["rating"]
        rating2 = self.rating_system.get_rating(match.opponent_id)["rating"]
        
        rating_bonus1 = min(rating1 / 150, 8)
        rating_bonus2 = min(rating2 / 150, 8)
        
        total_power1 = power1 + rating_bonus1
        total_power2 = power2 + rating_bonus2
        
        power_diff = total_power1 - total_power2
        
        goals1 = max(0, int(1 + (power_diff / 20) + random.randint(0, 2)))
        goals2 = max(0, int(1 + (-power_diff / 20) + random.randint(0, 2)))
        
        match.score = [goals1, goals2]
        
        if goals1 > goals2:
            match.winner = match.challenger_id
            self.rating_system.update_rating(match.challenger_id, match.opponent_id)
        elif goals2 > goals1:
            match.winner = match.opponent_id
            self.rating_system.update_rating(match.opponent_id, match.challenger_id)
        else:
            match.winner = "draw"
            self.rating_system.update_rating(match.challenger_id, match.opponent_id, is_draw=True)
        
        if match.bet_amount > 0 and match.winner != "draw":
            winner_game = get_user_game(match.winner)
            loser_id = match.opponent_id if match.winner == match.challenger_id else match.challenger_id
            loser_game = get_user_game(loser_id)
            
            prize = int(match.bet_amount * 1.6)
            winner_game.money += prize
            winner_game.save_game()
        
        match.status = "finished"
        self.save_pvp_data()
        return match

pvp_manager = PvPManager()
user_usernames = {}

# === Ğ‘ĞĞ—Ğ ĞšĞ›Ğ£Ğ‘ĞĞ’ ===
FOOTBALL_CLUBS = {
    "Ğ ĞµĞ°Ğ» ĞœĞ°Ğ´Ñ€Ğ¸Ğ´": {
        "players": [
            {"name": "Ğ‘ĞµĞ»Ğ»Ğ¸Ğ½Ğ³ĞµĞ¼", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 89, "defense": 72, "salary": 120000, "value": 180000000},
            {"name": "Ğ’Ğ¸Ğ½Ğ¸ÑĞ¸ÑƒÑ", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 88, "defense": 45, "salary": 110000, "value": 170000000},
            {"name": "ĞšÑƒÑ€Ñ‚ÑƒĞ°", "position": "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ", "attack": 25, "defense": 90, "salary": 130000, "value": 60000000},
            {"name": "ĞĞ»Ğ°Ğ±Ğ°", "position": "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 55, "defense": 84, "salary": 80000, "value": 40000000}
        ]
    },
    "Ğ‘Ğ°Ñ€ÑĞµĞ»Ğ¾Ğ½Ğ°": {
        "players": [
            {"name": "ĞŸĞµĞ´Ñ€Ğ¸", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 87, "defense": 68, "salary": 100000, "value": 150000000},
            {"name": "Ğ›ĞµĞ²Ğ°Ğ½Ğ´Ğ¾Ğ²ÑĞºĞ¸", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 86, "defense": 40, "salary": 120000, "value": 30000000},
            {"name": "ĞÑ€Ğ°ÑƒÑ…Ğ¾", "position": "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 50, "defense": 86, "salary": 90000, "value": 70000000},
            {"name": "Ğ¢ĞµÑ€ Ğ¨Ñ‚ĞµĞ³ĞµĞ½", "position": "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ", "attack": 30, "defense": 88, "salary": 110000, "value": 35000000}
        ]
    },
    "ĞœĞ°Ğ½ Ğ¡Ğ¸Ñ‚Ğ¸": {
        "players": [
            {"name": "Ğ¥Ğ¾Ğ»Ğ°Ğ½Ğ½", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 91, "defense": 48, "salary": 150000, "value": 180000000},
            {"name": "Ğ”Ğµ Ğ±Ñ€ÑĞ¹Ğ½Ğµ", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 90, "defense": 65, "salary": 140000, "value": 60000000},
            {"name": "Ğ Ğ¾Ğ´Ñ€Ğ¸", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 82, "defense": 85, "salary": 120000, "value": 100000000},
            {"name": "Ğ”Ğ¾Ğ½Ğ°Ñ€ÑƒĞ¼Ğ¼Ğ°", "position": "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ", "attack": 35, "defense": 87, "salary": 100000, "value": 40000000}
        ]
    },
    "Ğ›Ğ¸Ğ²ĞµÑ€Ğ¿ÑƒĞ»ÑŒ": {
        "players": [
            {"name": "Ğ¡Ğ°Ğ»Ğ°Ñ…", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 88, "defense": 50, "salary": 120000, "value": 65000000},
            {"name": "Ğ’Ğ°Ğ½ Ğ”ĞµĞ¹Ğº", "position": "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 55, "defense": 89, "salary": 110000, "value": 45000000},
            {"name": "ĞšĞ¾Ğ½Ğ°Ñ‚Ğµ", "position": "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 75, "defense": 78, "salary": 100000, "value": 70000000},
            {"name": "ĞĞ»Ğ¸ÑÑĞ¾Ğ½", "position": "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ", "attack": 30, "defense": 89, "salary": 100000, "value": 45000000}
        ]
    },
    "Ğ‘Ğ°Ğ²Ğ°Ñ€Ğ¸Ñ": {
        "players": [
            {"name": "ĞšĞµĞ¹Ğ½", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 90, "defense": 52, "salary": 130000, "value": 90000000},
            {"name": "ĞšĞ¸Ğ¼Ğ¼Ğ¸Ñ…", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 85, "defense": 80, "salary": 120000, "value": 75000000},
            {"name": "Ğ”Ğ¶Ğ°ĞºÑĞ¾Ğ½", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 84, "defense": 60, "salary": 100000, "value": 25000000},
            {"name": "ĞĞ¾Ğ¹ĞµÑ€", "position": "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ", "attack": 40, "defense": 86, "salary": 90000, "value": 10000000}
        ]
    }
}

# === Ğ Ğ•ĞĞ›Ğ¬ĞĞ«Ğ• Ğ˜Ğ“Ğ ĞĞšĞ˜ Ğ”Ğ›Ğ¯ Ğ¢Ğ ĞĞĞ¡Ğ¤Ğ•Ğ ĞĞĞ“Ğ Ğ Ğ«ĞĞšĞ ===
REAL_PLAYERS = [
    {"name": "ĞœĞ±Ğ°Ğ¿Ğ¿Ğµ", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 92, "defense": 40, "price": 4500000, "country": "ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†Ğ¸Ñ", "stars": 5},
    {"name": "Ğ˜ÑĞ°Ğº", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 91, "defense": 48, "price": 4200000, "country": "ğŸ‡³ğŸ‡´ ĞĞ¾Ñ€Ğ²ĞµĞ³Ğ¸Ñ", "stars": 5},
    {"name": "ĞœĞµÑÑĞ¸", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 90, "defense": 38, "price": 3800000, "country": "ğŸ‡¦ğŸ‡· ĞÑ€Ğ³ĞµĞ½Ñ‚Ğ¸Ğ½Ğ°", "stars": 5},
    {"name": "Ğ”Ğµ Ğ‘Ñ€Ğ¾Ğ¹Ğ½Ğµ", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 90, "defense": 65, "price": 4000000, "country": "ğŸ‡§ğŸ‡ª Ğ‘ĞµĞ»ÑŒĞ³Ğ¸Ñ", "stars": 5},
    {"name": "ĞĞ»ÑŒĞ¼Ğ¾", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 89, "defense": 70, "price": 3500000, "country": "ğŸ‡§ğŸ‡· Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ", "stars": 4},
    {"name": "Ğ’Ğ°Ğ½ Ğ”ĞµĞ¹Ğº", "position": "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 55, "defense": 89, "price": 3200000, "country": "ğŸ‡³ğŸ‡± ĞĞ¸Ğ´ĞµÑ€Ğ»Ğ°Ğ½Ğ´Ñ‹", "stars": 4},
    {"name": "Ğ Ğ°Ğ¼Ğ¾Ñ", "position": "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 60, "defense": 87, "price": 2800000, "country": "ğŸ‡ªğŸ‡¸ Ğ˜ÑĞ¿Ğ°Ğ½Ğ¸Ñ", "stars": 4},
    {"name": "ĞœĞ¸Ğ»Ğ¸Ñ‚aĞ¾", "position": "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 58, "defense": 86, "price": 3000000, "country": "ğŸ‡§ğŸ‡· Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ", "stars": 4},
    {"name": "ĞĞ»Ğ¸ÑÑĞ¾Ğ½", "position": "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ", "attack": 30, "defense": 89, "price": 2500000, "country": "ğŸ‡§ğŸ‡· Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ", "stars": 4},
    {"name": "ĞĞ±Ğ»ak", "position": "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ", "attack": 35, "defense": 88, "price": 2200000, "country": "ğŸ‡¸ğŸ‡® Ğ¡Ğ»Ğ¾Ğ²ĞµĞ½Ğ¸Ñ", "stars": 4},
    {"name": "ĞĞ»ÑŒĞ²Ğ°Ñ€ĞµĞ·", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 84, "defense": 35, "price": 1800000, "country": "ğŸ‡ªğŸ‡¸ Ğ˜ÑĞ¿Ğ°Ğ½Ğ¸Ñ", "stars": 3},
    {"name": "Ğ‘ĞµĞ»Ğ»Ğ¸Ğ½Ğ³ĞµĞ¼", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 86, "defense": 68, "price": 2000000, "country": "ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ ĞĞ½Ğ³Ğ»Ğ¸Ñ", "stars": 4},
    {"name": "Ğ“Ğ°Ğ²Ğ¸", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 82, "defense": 62, "price": 1600000, "country": "ğŸ‡ªğŸ‡¸ Ğ˜ÑĞ¿Ğ°Ğ½Ğ¸Ñ", "stars": 3},
    {"name": "Ğ¡Ğ°Ğºa", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 85, "defense": 42, "price": 1900000, "country": "ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ ĞĞ½Ğ³Ğ»Ğ¸Ñ", "stars": 3},
    {"name": "Ğ¡Ğ¼Ğ¾Ğ»Ğ¾Ğ²", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 78, "defense": 38, "price": 1200000, "country": "ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ", "stars": 3},
    {"name": "Ğ“Ğ¾Ğ»Ğ¾Ğ²Ğ¸Ğ½", "position": "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "attack": 80, "defense": 65, "price": 1500000, "country": "ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ", "stars": 3},
    {"name": "Ğ”Ğ·ÑĞ±Ğ°", "position": "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "attack": 76, "defense": 45, "price": 1000000, "country": "ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ", "stars": 2},
    {"name": "ĞĞºĞ¸Ğ½Ñ„ĞµĞµĞ²", "position": "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ", "attack": 25, "defense": 82, "price": 800000, "country": "ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ", "stars": 2},
]

# === ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞšĞ›ĞĞ¡Ğ¡ Ğ˜Ğ“Ğ Ğ« ===
class AdvancedFootballManager:
    def __init__(self, user_id):
        self.user_id = user_id
        self.load_game()
        
        if not hasattr(self, 'points'):
            self.club_name = None
            self.points = 0
            self.money = 10000000
            self.week = 1
            self.players = []
            self.league_teams = [
                {"name": "Barcelona FC", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "Chelsea", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "Tottenham", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "Atl Madrid", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "Man United", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "PSG", "points": 0, "goals_for": 0, "goals_against": 0}
            ]
            self.academy = {
                "level": 1,
                "training_cost": 500000,
                "next_refresh": 0,
                "current_player": None
            }
        
        self.generate_transfer_market()
    
    def save_game(self):
        game_data = {
            'club_name': self.club_name,
            'points': self.points,
            'money': self.money, 
            'week': self.week,
            'players': self.players,
            'league_teams': self.league_teams,
            'academy': self.academy
        }
        try:
            with open(f'/tmp/football_save_{self.user_id}.json', 'w') as f:
                json.dump(game_data, f)
        except Exception as e:
            print(f"ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ: {e}")
    
    def load_game(self):
        try:
            with open(f'/tmp/football_save_{self.user_id}.json', 'r') as f:
                game_data = json.load(f)
                self.club_name = game_data['club_name']
                self.points = game_data['points']
                self.money = game_data['money']
                self.week = game_data['week'] 
                self.players = game_data['players']
                self.league_teams = game_data['league_teams']
                self.academy = game_data['academy']
        except Exception as e:
            print(f"âŒ ĞĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ, Ğ½Ğ¾Ğ²Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°: {e}")
    
    def select_club(self, club_name):
        if club_name in FOOTBALL_CLUBS:
            self.club_name = club_name
            club_data = FOOTBALL_CLUBS[club_name]
            self.players = club_data['players'].copy()
            self.save_game()
            return f"âœ… Ğ’Ñ‹ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ»Ğ¸: {club_name}!\n\nĞ¢ĞµĞ¿ĞµÑ€ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞ¹Ñ‚Ğµ ÑĞ²Ğ¾Ğ¸Ğ¼ ĞºĞ»ÑƒĞ±Ğ¾Ğ¼ Ğº Ğ¿Ğ¾Ğ±ĞµĞ´Ğµ! ğŸ†"
        return "âŒ ĞšĞ»ÑƒĞ± Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½"
    
    def generate_transfer_market(self):
        self.transfer_players = []
        selected_players = random.sample(REAL_PLAYERS, min(6, len(REAL_PLAYERS)))
        
        for player_data in selected_players:
            player = player_data.copy()
            player["salary"] = player["price"] // 20
            player["value"] = player["price"]
            self.transfer_players.append(player)
    
    def calculate_team_power(self):
        if not self.players:
            return 50
        total_power = sum(p["attack"] + p["defense"] for p in self.players)
        return total_power / len(self.players)
    
    def play_match(self):
        team_power = self.calculate_team_power()
        opponent_index = (self.week - 1) % (len(self.league_teams) - 1)
        opponent = self.league_teams[opponent_index + 1]
        
        opponent_power = 60 + (self.week * 2) + random.randint(-10, 10)
        
        power_diff = team_power - opponent_power
        my_goals = max(0, int(1 + (power_diff / 20) + random.randint(0, 2)))
        opponent_goals = max(0, int(1 + (-power_diff / 20) + random.randint(0, 2)))
        
        self.league_teams[0]["goals_for"] += my_goals
        self.league_teams[0]["goals_against"] += opponent_goals
        opponent["goals_for"] += opponent_goals
        opponent["goals_against"] += my_goals
        
        if my_goals > opponent_goals:
            result = f"ĞŸĞĞ‘Ğ•Ğ”Ğ {my_goals}-{opponent_goals}! ğŸ‰"
            self.points += 3
            self.league_teams[0]["points"] += 3
            prize = 250000
        elif my_goals == opponent_goals:
            result = f"ĞĞ˜Ğ§Ğ¬Ğ¯ {my_goals}-{opponent_goals} ğŸ¤"
            self.points += 1
            self.league_teams[0]["points"] += 1
            opponent["points"] += 1
            prize = 120000
        else:
            result = f"ĞŸĞĞ ĞĞ–Ğ•ĞĞ˜Ğ• {my_goals}-{opponent_goals} ğŸ˜”"
            opponent["points"] += 3
            prize = 60000
        
        self.money += prize
        self.week += 1
        
        salary_info = ""
        if self.week % 4 == 0:
            total_salary = sum(p["salary"] for p in self.players)
            self.money -= total_salary
            salary_info = f"\nğŸ’¸ Ğ—Ğ°Ñ€Ğ¿Ğ»Ğ°Ñ‚Ñ‹: -{total_salary:,}â‚¬"
        
        self.save_game()
        return f"ğŸ¯ ĞĞµĞ´ĞµĞ»Ñ {self.week-1}\nâš”ï¸ ĞŸÑ€Ğ¾Ñ‚Ğ¸Ğ²: {opponent['name']}\n{result}\nğŸ’° ĞŸÑ€Ğ¸Ğ·: +{prize:,}â‚¬{salary_info}\nğŸ† ĞÑ‡ĞºĞ¾Ğ²: {self.points}\nğŸ’µ Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {self.money:,}â‚¬"
    
    def show_league_table(self):
        sorted_teams = sorted(self.league_teams, key=lambda x: (-x["points"], -(x["goals_for"] - x["goals_against"])))
        
        table = "ğŸ† Ğ¢ĞĞ‘Ğ›Ğ˜Ğ¦Ğ Ğ›Ğ˜Ğ“Ğ˜:\n\n"
        table += "â„–  ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°           Ğ  Ğ“Ğ—  Ğ“ĞŸ  Ğ \n"
        table += "â”€" * 30 + "\n"
        
        for i, team in enumerate(sorted_teams, 1):
            goals_diff = team["goals_for"] - team["goals_against"]
            goals_diff_str = f"+{goals_diff}" if goals_diff > 0 else str(goals_diff)
            emoji = "ğŸ¥‡" if i == 1 else "ğŸ¥ˆ" if i == 2 else "ğŸ¥‰" if i == 3 else "  "
            table += f"{i:<2}{emoji} {team['name']:<15} {team['points']:<2} {team['goals_for']:<2} {team['goals_against']:<2} {goals_diff_str:<3}\n"
        
        table += f"\nğŸ“… Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ğ½ĞµĞ´ĞµĞ»Ñ: {self.week}"
        return table
    
    def show_transfer_market(self):
        if not self.transfer_players:
            self.generate_transfer_market()
        
        market = "ğŸ›’ Ğ¢Ğ ĞĞĞ¡Ğ¤Ğ•Ğ ĞĞ«Ğ™ Ğ Ğ«ĞĞĞš Ğ¡Ğ Ğ—Ğ’Ğ•Ğ—Ğ”ĞĞœĞ˜!\n\n"
        for i, player in enumerate(self.transfer_players, 1):
            stars = "â­" * player.get("stars", 3)
            market += f"{i}. {player['name']} {player['country']}\n"
            market += f"   ğŸ“ {player['position']} | âš”ï¸{player['attack']} ğŸ›¡ï¸{player['defense']}\n"
            market += f"   {stars}\n"
            market += f"   ğŸ’° {player['price']:,}â‚¬\n\n"
        
        market += "ğŸ›’ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n/buy [Ğ½Ğ¾Ğ¼ĞµÑ€] - ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°\n/sell [Ğ½Ğ¾Ğ¼ĞµÑ€] - ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°\n/refresh - ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ñ‹Ğ½Ğ¾Ğº"
        return market
    
    def buy_player(self, player_num):
        try:
            player_index = int(player_num) - 1
            if player_index < 0 or player_index >= len(self.transfer_players):
                return "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°!"
            
            player = self.transfer_players[player_index]
            
            if self.money < player["price"]:
                return f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³! ĞÑƒĞ¶Ğ½Ğ¾ {player['price']:,}â‚¬"
            
            if len(self.players) >= 8:
                return "âŒ Ğ’ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 8 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²! Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¹ ĞºĞ¾Ğ³Ğ¾-Ñ‚Ğ¾."
            
            new_player = player.copy()
            new_player["salary"] = player["price"] // 20
            new_player["value"] = player["price"]
            self.players.append(new_player)
            
            self.money -= player["price"]
            self.transfer_players.pop(player_index)
            
            self.save_game()
            return f"âœ… Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞĞ¯ ĞŸĞĞšĞ£ĞŸĞšĞ!\nğŸ‘¤ {new_player['name']} ({new_player['position']})\nâ­ âš”ï¸{new_player['attack']} ğŸ›¡ï¸{new_player['defense']}\nğŸ’µ Ğ¦ĞµĞ½Ğ°: {player['price']:,}â‚¬\nğŸ’° ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ: {self.money:,}â‚¬"
        
        except ValueError:
            return "âŒ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: /buy [Ğ½Ğ¾Ğ¼ĞµÑ€]"
    
    def sell_player(self, player_num):
        try:
            player_index = int(player_num) - 1
            if player_index < 0 or player_index >= len(self.players):
                return "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°!"
            
            if len(self.players) <= 4:
                return "âŒ Ğ’ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 4 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°!"
            
            player = self.players[player_index]
            sell_price = player["value"] * 0.8
            
            self.money += sell_price
            self.players.pop(player_index)
            
            self.save_game()
            return f"âœ… Ğ˜Ğ“Ğ ĞĞš ĞŸĞ ĞĞ”ĞĞ!\nğŸ‘¤ {player['name']} ({player['position']})\nğŸ’µ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¾: {sell_price:,.0f}â‚¬\nğŸ’° Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {self.money:,}â‚¬"
        
        except ValueError:
            return "âŒ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: /sell [Ğ½Ğ¾Ğ¼ĞµÑ€]"
    
    def refresh_market(self):
        self.generate_transfer_market()
        return "ğŸ”ƒ Ğ¢Ñ€Ğ°Ğ½ÑÑ„ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ€Ñ‹Ğ½Ğ¾Ğº Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½! ĞĞ¾Ğ²Ñ‹Ğµ Ğ·Ğ²ĞµĞ·Ğ´Ñ‹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹!"
    
    def generate_youth_player(self):
        level = self.academy["level"]
        positions = ["ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹", "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº", "Ğ’Ñ€Ğ°Ñ‚Ğ°Ñ€ÑŒ"]
        names = ["ĞĞ¾Ğ²Ğ¸ĞºĞ¾Ğ²", "ĞœĞ¾Ğ»Ğ¾Ğ´Ñ†Ğ¾Ğ²", "Ğ¢Ğ°Ğ»Ğ°Ğ½Ñ‚Ğ¾Ğ²", "Ğ‘ÑƒĞ´ÑƒÑ‰Ğ¸Ğ¹", "Ğ—Ğ²ĞµĞ·Ğ´Ğ¾Ğ²", "ĞĞ°Ğ´ĞµĞ¶Ğ´Ğ¸Ğ½"]
        
        min_power = 60 + (level - 1) * 5
        max_power = 70 + (level - 1) * 5
        
        position = random.choice(positions)
        if position == "ĞĞ°Ğ¿Ğ°Ğ´Ğ°ÑÑ‰Ğ¸Ğ¹":
            attack = random.randint(min_power, max_power)
            defense = random.randint(30, 50)
        elif position == "ĞŸĞ¾Ğ»ÑƒĞ·Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº":
            attack = random.randint(min_power - 5, max_power - 5)
            defense = random.randint(min_power - 10, max_power - 10)
        elif position == "Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ½Ğ¸Ğº":
            attack = random.randint(40, 60)
            defense = random.randint(min_power, max_power)
        else:
            attack = random.randint(20, 40)
            defense = random.randint(min_power, max_power)
        
        player = {
            "name": f"{random.choice(names)}-Ğ¼Ğ».",
            "position": position,
            "attack": attack,
            "defense": defense,
            "salary": 10000 * level,
            "value": 500000 * level,
            "from_academy": True
        }
        
        return player
    
    def upgrade_academy(self):
        current_level = self.academy["level"]
        if current_level >= 5:
            return "âŒ ĞĞºĞ°Ğ´ĞµĞ¼Ğ¸Ñ ÑƒĞ¶Ğµ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ! ğŸ†"
        
        cost = self.academy["training_cost"]
        if self.money < cost:
            return f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³! ĞÑƒĞ¶Ğ½Ğ¾ {cost:,}â‚¬"
        
        self.money -= cost
        self.academy["level"] += 1
        self.academy["training_cost"] *= 2
        
        self.save_game()
        return f"âœ… ĞĞºĞ°Ğ´ĞµĞ¼Ğ¸Ñ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ° Ğ´Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ {self.academy['level']}!\nğŸ’° Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ: {cost:,}â‚¬\nğŸ’µ ĞÑÑ‚Ğ°Ğ»Ğ¾ÑÑŒ: {self.money:,}â‚¬"
    
    def get_academy_player(self):
        if self.academy["current_player"] is None:
            if self.week >= self.academy["next_refresh"]:
                self.academy["current_player"] = self.generate_youth_player()
                self.academy["next_refresh"] = self.week + 5
                self.save_game()
                return "ğŸ”„ Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼Ğ¾Ğ»Ğ¾Ğ´Ğ¾Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº! ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ 'ğŸ‘¥ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°'"
            else:
                weeks_left = self.academy["next_refresh"] - self.week
                return f"â³ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ±ÑƒĞ´ĞµÑ‚ Ñ‡ĞµÑ€ĞµĞ· {weeks_left} Ğ½ĞµĞ´ĞµĞ»ÑŒ"
        
        return "âœ… Ğ•ÑÑ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾Ğº Ğ² Ğ°ĞºĞ°Ğ´ĞµĞ¼Ğ¸Ğ¸! ĞĞ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ 'ğŸ‘¥ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°'"
    
    def claim_academy_player(self):
        if self.academy["current_player"] is None:
            return "âŒ ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ñ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ² Ğ°ĞºĞ°Ğ´ĞµĞ¼Ğ¸Ğ¸"
        
        if len(self.players) >= 8:
            return "âŒ Ğ’ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğµ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 8 Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²! Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ ĞºĞ¾Ğ³Ğ¾-Ñ‚Ğ¾."
        
        player = self.academy["current_player"]
        self.players.append(player)
        self.academy["current_player"] = None
        
        self.save_game()
        return f"âœ… Ğ˜Ğ³Ñ€Ğ¾Ğº Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ!\nğŸ‘¤ {player['name']} ({player['position']})\nâ­ âš”ï¸{player['attack']} ğŸ›¡ï¸{player['defense']}"
    
    def show_academy_info(self):
        academy_info = f"ğŸ« ĞĞšĞĞ”Ğ•ĞœĞ˜Ğ¯ [Ğ£Ñ€. {self.academy['level']}/5]\n\n"
        
        levels = {
            1: "ğŸ”¹ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‰Ğ°Ñ (60-70 ÑĞ¸Ğ»Ñ‹)",
            2: "ğŸ”¸ Ğ Ğ°Ğ·Ğ²Ğ¸Ğ²Ğ°ÑÑ‰Ğ°Ñ (65-75 ÑĞ¸Ğ»Ñ‹)", 
            3: "ğŸ”º ĞŸÑ€Ğ¾Ñ„ĞµÑÑĞ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ (70-80 ÑĞ¸Ğ»Ñ‹)",
            4: "ğŸ… Ğ­Ğ»Ğ¸Ñ‚Ğ½Ğ°Ñ (75-85 ÑĞ¸Ğ»Ñ‹)",
            5: "â­ Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ğ°Ñ (80-90 ÑĞ¸Ğ»Ñ‹)"
        }
        
        academy_info += f"{levels[self.academy['level']]}\n"
        academy_info += f"ğŸ’° Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰ĞµĞµ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğµ: {self.academy['training_cost']:,}â‚¬\n\n"
        
        if self.academy["current_player"]:
            player = self.academy["current_player"]
            academy_info += f"ğŸ‘¥ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ¸Ğ³Ñ€Ğ¾Ğº:\n"
            academy_info += f"ğŸ‘¤ {player['name']} ({player['position']})\n"
            academy_info += f"â­ âš”ï¸{player['attack']} ğŸ›¡ï¸{player['defense']}\n"
        else:
            if self.week >= self.academy["next_refresh"]:
                academy_info += "ğŸ”„ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº!\n"
            else:
                weeks_left = self.academy["next_refresh"] - self.week
                academy_info += f"â³ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº Ñ‡ĞµÑ€ĞµĞ· {weeks_left} Ğ½ĞµĞ´ĞµĞ»ÑŒ\n"
        
        return academy_info

# === Ğ“Ğ›ĞĞ‘ĞĞ›Ğ¬ĞĞ«Ğ• ĞŸĞ•Ğ Ğ•ĞœĞ•ĞĞĞ«Ğ• ===
user_games = {}

def get_user_game(user_id):
    if user_id not in user_games:
        user_games[user_id] = AdvancedFootballManager(user_id)
    return user_games[user_id]

def find_user_by_username(username):
    username = username.lower()
    for user_id, user_username in user_usernames.items():
        if user_username and user_username.lower() == username:
            return user_id
    return None

def send_pvp_result(match):
    challenger_game = get_user_game(match.challenger_id)
    opponent_game = get_user_game(match.opponent_id)
    
    result_text = f"âš”ï¸ Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ ĞœĞĞ¢Ğ§Ğ PvP!\n\n"
    result_text += f"ğŸ† {challenger_game.club_name} {match.score[0]} - {match.score[1]} {opponent_game.club_name}\n\n"
    
    if match.winner == "draw":
        result_text += "ğŸ¤ ĞĞ˜Ğ§Ğ¬Ğ¯!\n"
        if match.bet_amount > 0:
            challenger_game.money += match.bet_amount
            opponent_game.money += match.bet_amount
            challenger_game.save_game()
            opponent_game.save_game()
            result_text += f"ğŸ’° Ğ¡Ñ‚Ğ°Ğ²ĞºĞ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰ĞµĞ½Ñ‹!"
    else:
        winner_game = get_user_game(match.winner)
        result_text += f"ğŸ‰ ĞŸĞĞ‘Ğ•Ğ”Ğ˜Ğ›: {winner_game.club_name}!\n"
        
        if match.bet_amount > 0:
            prize = int(match.bet_amount * 1.6)
            result_text += f"ğŸ’° Ğ’Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ: {prize:,}â‚¬\n"
    
    bot.send_message(match.challenger_id, result_text)
    bot.send_message(match.opponent_id, result_text)

def cleanup_expired_matches():
    """ĞÑ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ Ğ¼Ğ°Ñ‚Ñ‡Ğ¸ ÑÑ‚Ğ°Ñ€ÑˆĞµ 30 Ğ¼Ğ¸Ğ½ÑƒÑ‚"""
    current_time = time.time()
    expired_matches = []
    
    for match_id, match in pvp_manager.active_matches.items():
        if match.status == "pending" and (current_time - match.created_time) > 1800:
            expired_matches.append(match_id)
    
    for match_id in expired_matches:
        match = pvp_manager.active_matches[match_id]
        if match.bet_amount > 0:
            challenger_game = get_user_game(match.challenger_id)
            challenger_game.money += match.bet_amount
            challenger_game.save_game()
        
        bot.send_message(match.challenger_id, "Ğ’Ğ°Ñˆ Ğ²Ñ‹Ğ·Ğ¾Ğ² Ğ¸ÑÑ‚ĞµĞº (30 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾).")
        if match.opponent_id in pvp_manager.pending_requests:
            bot.send_message(match.opponent_id, "Ğ’Ñ‹Ğ·Ğ¾Ğ² Ğ¸ÑÑ‚ĞµĞº.")
            del pvp_manager.pending_requests[match.opponent_id]
        
        del pvp_manager.active_matches[match_id]

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºÑƒ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ
cleanup_expired_matches()

# === ĞĞ¡ĞĞĞ’ĞĞĞ• ĞœĞ•ĞĞ® Ğ˜ ĞšĞĞœĞĞĞ”Ğ« ===
@bot.message_handler(commands=['start'])
def start_command(message):
    if message.from_user.username:
        user_usernames[message.chat.id] = message.from_user.username
    
    game = get_user_game(message.chat.id)
    
    if game.club_name is None:
        keyboard = InlineKeyboardMarkup()
        clubs = list(FOOTBALL_CLUBS.keys())
        
        for i in range(0, len(clubs), 2):
            row = []
            row.append(InlineKeyboardButton(clubs[i], callback_data=f"club_{clubs[i]}"))
            if i + 1 < len(clubs):
                row.append(InlineKeyboardButton(clubs[i+1], callback_data=f"club_{clubs[i+1]}"))
            keyboard.add(*row)
        
        bot.send_message(message.chat.id, 
            "âš½ Ğ”ĞĞ‘Ğ Ğ ĞŸĞĞ–ĞĞ›ĞĞ’ĞĞ¢Ğ¬ Ğ’ Ğ¤Ğ£Ğ¢Ğ‘ĞĞ›Ğ¬ĞĞ«Ğ™ ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ  2025! ğŸ†\n\n"
            "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ²Ğ¾Ğ¹ ĞºĞ»ÑƒĞ±:",
            reply_markup=keyboard)
    else:
        show_main_menu(message.chat.id, game)

def show_main_menu(chat_id, game):
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton("ğŸ‘¥ ĞœĞ¾Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°", callback_data="menu_team"))
    keyboard.add(InlineKeyboardButton("âš½ Ğ¡Ñ‹Ğ³Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ°Ñ‚Ñ‡", callback_data="menu_play"))
    keyboard.add(InlineKeyboardButton("ğŸ† Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ»Ğ¸Ğ³Ğ¸", callback_data="menu_table"))
    keyboard.add(InlineKeyboardButton("ğŸ›’ Ğ¢Ñ€Ğ°Ğ½ÑÑ„ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ€Ñ‹Ğ½Ğ¾Ğº", callback_data="menu_market"))
    keyboard.add(InlineKeyboardButton("ğŸ« ĞĞºĞ°Ğ´ĞµĞ¼Ğ¸Ñ", callback_data="menu_academy"))
    keyboard.add(InlineKeyboardButton("ğŸ’µ Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑÑ‹", callback_data="menu_money"))
    keyboard.add(InlineKeyboardButton("âš”ï¸ PvP", callback_data="menu_pvp"))
    
    bot.send_message(chat_id,
        f"ğŸ† {game.club_name}\n"
        f"ğŸ’µ Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {game.money:,}â‚¬\n"
        f"ğŸ… ĞÑ‡ĞºĞ¾Ğ²: {game.points}\n"
        f"ğŸ“… ĞĞµĞ´ĞµĞ»Ñ: {game.week}\n\n"
        "Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ:",
        reply_markup=keyboard)

# === PvP ĞšĞĞœĞĞĞ”Ğ« ===
@bot.message_handler(commands=['challenge'])
def challenge_command(message):
    try:
        if message.from_user.username:
            user_usernames[message.chat.id] = message.from_user.username
            
        game = get_user_game(message.chat.id)
        if game.club_name is None:
            start_command(message)
            return
        
        parts = message.text.split()
        if len(parts) < 2:
            bot.send_message(message.chat.id, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: /challenge @username [ÑÑ‚Ğ°Ğ²ĞºĞ°]")
            return
        
        username = parts[1].replace('@', '').strip()
        bet_amount = 0
        
        if len(parts) > 2:
            try:
                bet_amount = int(parts[2])
                if bet_amount < 0:
                    bot.send_message(message.chat.id, "Ğ¡Ñ‚Ğ°Ğ²ĞºĞ° Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¾Ñ‚Ñ€Ğ¸Ñ†Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğ¹!")
                    return
                if game.money < bet_amount:
                    bot.send_message(message.chat.id, f"ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ²ĞºĞ¸! ĞÑƒĞ¶Ğ½Ğ¾ {bet_amount:,}â‚¬")
                    return
            except ValueError:
                bot.send_message(message.chat.id, "ĞĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ÑÑ‚Ğ°Ğ²ĞºĞ°! Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: /challenge @username [ÑÑ‚Ğ°Ğ²ĞºĞ°]")
                return
        
        opponent_id = find_user_by_username(username)
        
        if not opponent_id:
            bot.send_message(message.chat.id, "ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½! Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ Ñ‡Ñ‚Ğ¾ username Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸ Ğ¾Ğ½ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ğ» Ğ±Ğ¾Ñ‚Ğ°.")
            return
        
        if opponent_id == message.chat.id:
            bot.send_message(message.chat.id, "ĞĞµĞ»ÑŒĞ·Ñ Ğ²Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ ÑĞ°Ğ¼Ğ¾Ğ³Ğ¾ ÑĞµĞ±Ñ!")
            return
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¼Ğ°Ñ‚Ñ‡
        match = pvp_manager.create_match(message.chat.id, opponent_id, bet_amount)
        
        challenger_game = get_user_game(message.chat.id)
        opponent_game = get_user_game(opponent_id)
        
        challenge_text = "âš”ï¸ Ğ’Ğ«Ğ—ĞĞ’ ĞĞ ĞœĞĞ¢Ğ§!\n\n"
        challenge_text += f"ğŸ‘¤ Ğ˜Ğ³Ñ€Ğ¾Ğº: {message.from_user.username or 'ĞĞ½Ğ¾Ğ½Ğ¸Ğ¼'}\n"
        challenge_text += f"ğŸ† ĞšĞ»ÑƒĞ±: {challenger_game.club_name}\n"
        challenge_text += f"â­ Ğ¡Ğ¸Ğ»Ğ°: {challenger_game.calculate_team_power():.1f}\n"
        
        if bet_amount > 0:
            challenge_text += f"ğŸ’° Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°: {bet_amount:,}â‚¬\n\n"
        else:
            challenge_text += f"ğŸ’° Ğ¡Ñ‚Ğ°Ğ²ĞºĞ°: Ğ½ĞµÑ‚\n\n"
        
        challenge_text += f"ĞŸÑ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ²Ñ‹Ğ·Ğ¾Ğ²?"
        
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("âœ… ĞŸĞ Ğ˜ĞĞ¯Ğ¢Ğ¬", callback_data=f"pvp_accept_{match.match_id}"))
        keyboard.add(InlineKeyboardButton("âŒ ĞĞ¢ĞšĞ›ĞĞĞ˜Ğ¢Ğ¬", callback_data=f"pvp_decline_{match.match_id}"))
        
        bot.send_message(opponent_id, challenge_text, reply_markup=keyboard)
        bot.send_message(message.chat.id, f"âœ… Ğ’Ñ‹Ğ·Ğ¾Ğ² Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ¸Ğ³Ñ€Ğ¾ĞºÑƒ @{username}!")
        
    except Exception as e:
        print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² challenge: {e}")
        bot.send_message(message.chat.id, "ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ°")

@bot.message_handler(commands=['rating'])
def rating_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
        return
    
    rating_data = pvp_manager.rating_system.get_rating(message.chat.id)
    
    rating_text = f"ğŸ“Š Ğ’ĞĞ¨ Ğ Ğ•Ğ™Ğ¢Ğ˜ĞĞ“ PvP\n\n"
    rating_text += f"â­ Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³: {rating_data['rating']}\n"
    rating_text += f"âœ… ĞŸĞ¾Ğ±ĞµĞ´: {rating_data['wins']}\n"
    rating_text += f"âŒ ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹: {rating_data['losses']}\n"
    rating_text += f"ğŸ¤ ĞĞ¸Ñ‡ÑŒĞ¸Ñ…: {rating_data['draws']}\n\n"
    
    if rating_data['wins'] + rating_data['losses'] + rating_data['draws'] > 0:
        total = rating_data['wins'] + rating_data['losses'] + rating_data['draws']
        win_rate = (rating_data['wins'] / total) * 100
        rating_text += f"ğŸ“ˆ Ğ’Ğ¸Ğ½Ñ€ĞµĞ¹Ñ‚: {win_rate:.1f}%"
    
    bot.send_message(message.chat.id, rating_text)

@bot.message_handler(commands=['top'])
def top_command(message):
    top_players = sorted(
        [(user_id, data) for user_id, data in pvp_manager.rating_system.ratings.items()],
        key=lambda x: x[1]['rating'],
        reverse=True
    )[:10]
    
    top_text = "ğŸ† Ğ¢ĞĞŸ-10 Ğ˜Ğ“Ğ ĞĞšĞĞ’ PvP\n\n"
    
    for i, (user_id, data) in enumerate(top_players, 1):
        try:
            user_game = get_user_game(user_id)
            emoji = "ğŸ¥‡" if i == 1 else "ğŸ¥ˆ" if i == 2 else "ğŸ¥‰" if i == 3 else "ğŸ”¸"
            username = user_usernames.get(user_id, "ĞĞ½Ğ¾Ğ½Ğ¸Ğ¼")
            top_text += f"{emoji} {i}. {user_game.club_name} ({username}) - {data['rating']}â­\n"
        except:
            continue
    
    bot.send_message(message.chat.id, top_text)

# === ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ PvP ĞšĞĞ›Ğ‘Ğ­ĞšĞĞ’ ===
@bot.callback_query_handler(func=lambda call: call.data.startswith('pvp_accept_'))
def handle_pvp_accept(call):
    try:
        match_id = call.data[10:]
        print(f"ğŸ”„ ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚ÑŒ Ğ¼Ğ°Ñ‚Ñ‡: {match_id}")
        
        # Ğ˜Ñ‰ĞµĞ¼ Ğ¼Ğ°Ñ‚Ñ‡
        match = pvp_manager.active_matches.get(match_id)
        
        if not match:
            print(f"âŒ ĞœĞ°Ñ‚Ñ‡ {match_id} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
            bot.answer_callback_query(call.id, "âŒ ĞœĞ°Ñ‚Ñ‡ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ¸Ğ»Ğ¸ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ»!")
            return
            
        if match.status != "pending":
            bot.answer_callback_query(call.id, "âŒ ĞœĞ°Ñ‚Ñ‡ ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½!")
            return
        
        if call.message.chat.id != match.opponent_id:
            bot.answer_callback_query(call.id, "âŒ Ğ­Ñ‚Ğ¾ Ğ½Ğµ Ğ²Ğ°Ñˆ Ğ²Ñ‹Ğ·Ğ¾Ğ²!")
            return
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´ĞµĞ½ÑŒĞ³Ğ¸ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ²ĞºĞ¸
        opponent_game = get_user_game(match.opponent_id)
        if match.bet_amount > 0 and opponent_game.money < match.bet_amount:
            bot.answer_callback_query(call.id, f"âŒ ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´ĞµĞ½ĞµĞ³ Ğ´Ğ»Ñ ÑÑ‚Ğ°Ğ²ĞºĞ¸! ĞÑƒĞ¶Ğ½Ğ¾ {match.bet_amount:,}â‚¬")
            return
        
        # Ğ¡Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ğ²ĞºÑƒ Ñƒ Ğ¾Ğ¿Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
        if match.bet_amount > 0:
            opponent_game.money -= match.bet_amount
            opponent_game.save_game()
        
        print(f"âœ… ĞŸÑ€Ğ¸Ğ½Ğ¸Ğ¼Ğ°ĞµĞ¼ Ğ¼Ğ°Ñ‚Ñ‡: {match_id}")
        
        # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¸ Ñ€Ğ°ÑÑÑ‡Ğ¸Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        match.status = "accepted"
        match = pvp_manager.calculate_pvp_result(match)
        
        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹
        send_pvp_result(match)
        
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ¸Ğ· pending
        if match.opponent_id in pvp_manager.pending_requests:
            del pvp_manager.pending_requests[match.opponent_id]
        
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
        pvp_manager.save_pvp_data()
            
        bot.answer_callback_query(call.id, "âœ… ĞœĞ°Ñ‚Ñ‡ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚! Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½.")
        
    except Exception as e:
        print(f"ğŸ”¥ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² pvp_accept: {e}")
        bot.answer_callback_query(call.id, "âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ñ€Ğ¸Ğ½ÑÑ‚Ğ¸Ğ¸ Ğ¼Ğ°Ñ‚Ñ‡Ğ°")

@bot.callback_query_handler(func=lambda call: call.data.startswith('pvp_decline_'))
def handle_pvp_decline(call):
    try:
        match_id = call.data[11:]
        match = pvp_manager.active_matches.get(match_id)
        
        if match and match.status == "pending":
            # Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ğ²ĞºÑƒ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ÑÑ‰ĞµĞ¼Ñƒ
            if match.bet_amount > 0:
                challenger_game = get_user_game(match.challenger_id)
                challenger_game.money += match.bet_amount
                challenger_game.save_game()
            
            match.status = "declined"
            
            # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑĞµĞ¼ Ğ¾Ğ±Ğ¾Ğ¸Ñ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²
            bot.edit_message_text("âŒ Ğ’Ñ‹Ğ·Ğ¾Ğ² Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½!", call.message.chat.id, call.message.message_id)
            bot.send_message(match.challenger_id, "âŒ Ğ’Ğ°Ñˆ Ğ²Ñ‹Ğ·Ğ¾Ğ² Ğ±Ñ‹Ğ» Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½.")
            
            # Ğ§Ğ¸ÑÑ‚Ğ¸Ğ¼
            if match.opponent_id in pvp_manager.pending_requests:
                del pvp_manager.pending_requests[match.opponent_id]
            
            pvp_manager.save_pvp_data()
                
    except Exception as e:
        print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² pvp_decline: {e}")

# === ĞĞ‘Ğ ĞĞ‘ĞĞ¢Ğ§Ğ˜ĞšĞ˜ ĞĞ¡ĞĞĞ’ĞĞ«Ğ¥ ĞšĞĞ›Ğ‘Ğ­ĞšĞĞ’ ===
@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    try:
        game = get_user_game(call.message.chat.id)
        
        if call.data.startswith("club_"):
            club_name = call.data[5:]
            result = game.select_club(club_name)
            bot.edit_message_text(
                f"{result}\n\nĞ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚Ğµ {club_name}! ğŸ‰",
                call.message.chat.id,
                call.message.message_id
            )
            show_main_menu(call.message.chat.id, game)
        
        elif call.data == "menu_team":
            team_info = f"ğŸ† {game.club_name}\nğŸ’° Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {game.money:,}â‚¬\nğŸ… ĞÑ‡ĞºĞ¾Ğ²: {game.points}\nâ­ Ğ¡Ğ¸Ğ»Ğ°: {game.calculate_team_power():.1f}\n\n"
            team_info += "ğŸ‘¥ Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²:\n"
            for i, player in enumerate(game.players, 1):
                team_info += f"{i}. {player['name']} ({player['position']})\n"
                team_info += f"   âš”ï¸{player['attack']} ğŸ›¡ï¸{player['defense']} ğŸ’°{player['salary']:,}â‚¬\n"
            
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            
            bot.edit_message_text(team_info, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "menu_play":
            result = game.play_match()
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(result, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "menu_table":
            table = game.show_league_table()
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(table, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "menu_market":
            market = game.show_transfer_market()
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ñ‹Ğ½Ğ¾Ğº", callback_data="market_refresh"))
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(market, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "menu_academy":
            academy_info = game.show_academy_info()
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”„ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_check"))
            keyboard.add(InlineKeyboardButton("âš¡ Ğ£Ğ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ", callback_data="academy_upgrade"))
            keyboard.add(InlineKeyboardButton("ğŸ‘¥ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_claim"))
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(academy_info, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "menu_money":
            stats = f"ğŸ’µ Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {game.money:,}â‚¬\nğŸ… ĞÑ‡ĞºĞ¾Ğ²: {game.points}\nğŸ“… ĞĞµĞ´ĞµĞ»Ñ: {game.week}"
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(stats, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "menu_pvp":
            pvp_text = "âš”ï¸ PvP Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞ\n\n"
            pvp_text += "ğŸ® Ğ˜Ğ³Ñ€Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ñ‚Ğ¸Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²!\n\n"
            pvp_text += "ğŸ“‹ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:\n"
            pvp_text += "/challenge @username [ÑÑ‚Ğ°Ğ²ĞºĞ°] - Ğ’Ñ‹Ğ·Ğ²Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°\n"
            pvp_text += "/rating - Ğ’Ğ°Ñˆ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³\n"
            pvp_text += "/top - Ğ¢Ğ¾Ğ¿ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²\n\n"
            pvp_text += "ğŸ’¡ Ğ¡Ğ¾Ğ²ĞµÑ‚: Ğ£Ğ»ÑƒÑ‡ÑˆĞ°Ğ¹Ñ‚Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ±ĞµĞ¶Ğ´Ğ°Ñ‚ÑŒ Ğ² PvP!"
            
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ“Š ĞœĞ¾Ğ¹ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³", callback_data="pvp_rating"))
            keyboard.add(InlineKeyboardButton("ğŸ† Ğ¢Ğ¾Ğ¿ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ²", callback_data="pvp_top"))
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            
            bot.edit_message_text(pvp_text, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "menu_back":
            show_main_menu(call.message.chat.id, game)
        
        elif call.data == "market_refresh":
            result = game.refresh_market()
            market = game.show_transfer_market()
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ñ‹Ğ½Ğ¾Ğº", callback_data="market_refresh"))
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(f"{result}\n\n{market}", call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "academy_check":
            result = game.get_academy_player()
            academy_info = game.show_academy_info()
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”„ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_check"))
            keyboard.add(InlineKeyboardButton("âš¡ Ğ£Ğ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ", callback_data="academy_upgrade"))
            keyboard.add(InlineKeyboardButton("ğŸ‘¥ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_claim"))
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(f"{result}\n\n{academy_info}", call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "academy_upgrade":
            result = game.upgrade_academy()
            academy_info = game.show_academy_info()
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”„ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_check"))
            keyboard.add(InlineKeyboardButton("âš¡ Ğ£Ğ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ", callback_data="academy_upgrade"))
            keyboard.add(InlineKeyboardButton("ğŸ‘¥ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_claim"))
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(f"{result}\n\n{academy_info}", call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "academy_claim":
            result = game.claim_academy_player()
            academy_info = game.show_academy_info()
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”„ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_check"))
            keyboard.add(InlineKeyboardButton("âš¡ Ğ£Ğ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ", callback_data="academy_upgrade"))
            keyboard.add(InlineKeyboardButton("ğŸ‘¥ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_claim"))
            keyboard.add(InlineKeyboardButton("ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="menu_back"))
            bot.edit_message_text(f"{result}\n\n{academy_info}", call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "pvp_rating":
            rating_data = pvp_manager.rating_system.get_rating(call.message.chat.id)
            rating_text = f"ğŸ“Š Ğ’ĞĞ¨ Ğ Ğ•Ğ™Ğ¢Ğ˜ĞĞ“ PvP\n\nâ­ Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³: {rating_data['rating']}\nâœ… ĞŸĞ¾Ğ±ĞµĞ´: {rating_data['wins']}\nâŒ ĞŸĞ¾Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹: {rating_data['losses']}\nğŸ¤ ĞĞ¸Ñ‡ÑŒĞ¸Ñ…: {rating_data['draws']}"
            
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”™ Ğ’ Ğ¼ĞµĞ½Ñ PvP", callback_data="menu_pvp"))
            
            bot.edit_message_text(rating_text, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
        
        elif call.data == "pvp_top":
            top_players = sorted(
                [(user_id, data) for user_id, data in pvp_manager.rating_system.ratings.items()],
                key=lambda x: x[1]['rating'],
                reverse=True
            )[:10]
            
            top_text = "ğŸ† Ğ¢ĞĞŸ-10 Ğ˜Ğ“Ğ ĞĞšĞĞ’ PvP\n\n"
            
            for i, (user_id, data) in enumerate(top_players, 1):
                try:
                    user_game = get_user_game(user_id)
                    emoji = "ğŸ¥‡" if i == 1 else "ğŸ¥ˆ" if i == 2 else "ğŸ¥‰" if i == 3 else "ğŸ”¸"
                    username = user_usernames.get(user_id, "ĞĞ½Ğ¾Ğ½Ğ¸Ğ¼")
                    top_text += f"{emoji} {i}. {user_game.club_name} ({username}) - {data['rating']}â­\n"
                except:
                    continue
            
            keyboard = InlineKeyboardMarkup()
            keyboard.add(InlineKeyboardButton("ğŸ”™ Ğ’ Ğ¼ĞµĞ½Ñ PvP", callback_data="menu_pvp"))
            
            bot.edit_message_text(top_text, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    except Exception as e:
        print(f"ĞÑˆĞ¸Ğ±ĞºĞ° Ğ² Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞµ ĞºĞ¾Ğ»Ğ±ÑĞºĞ°: {e}")

# === Ğ¡Ğ¢ĞĞ Ğ«Ğ• Ğ¢Ğ•ĞšĞ¡Ğ¢ĞĞ’Ğ«Ğ• ĞšĞĞœĞĞĞ”Ğ« ===
@bot.message_handler(commands=['team'])
def team_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        team_info = f"ğŸ† {game.club_name}\nğŸ’° Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {game.money:,}â‚¬\nğŸ… ĞÑ‡ĞºĞ¾Ğ²: {game.points}\nâ­ Ğ¡Ğ¸Ğ»Ğ°: {game.calculate_team_power():.1f}\n\n"
        team_info += "ğŸ‘¥ Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²:\n"
        for i, player in enumerate(game.players, 1):
            team_info += f"{i}. {player['name']} ({player['position']})\n"
            team_info += f"   âš”ï¸{player['attack']} ğŸ›¡ï¸{player['defense']} ğŸ’°{player['salary']:,}â‚¬\n"
        bot.send_message(message.chat.id, team_info)

@bot.message_handler(commands=['play'])
def play_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, game.play_match())

@bot.message_handler(commands=['table'])
def table_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, game.show_league_table())

@bot.message_handler(commands=['market'])
def market_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, game.show_transfer_market())

@bot.message_handler(commands=['buy'])
def buy_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        parts = message.text.split()
        if len(parts) == 2:
            bot.send_message(message.chat.id, game.buy_player(parts[1]))
        else:
            bot.send_message(message.chat.id, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: /buy [Ğ½Ğ¾Ğ¼ĞµÑ€]")

@bot.message_handler(commands=['sell'])
def sell_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        parts = message.text.split()
        if len(parts) == 2:
            bot.send_message(message.chat.id, game.sell_player(parts[1]))
        else:
            bot.send_message(message.chat.id, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: /sell [Ğ½Ğ¾Ğ¼ĞµÑ€]")

@bot.message_handler(commands=['refresh'])
def refresh_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, game.refresh_market())

@bot.message_handler(commands=['money', 'points'])
def money_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, f"ğŸ’µ Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {game.money:,}â‚¬\nğŸ… ĞÑ‡ĞºĞ¾Ğ²: {game.points}\nğŸ“… ĞĞµĞ´ĞµĞ»Ñ: {game.week}")

@bot.message_handler(commands=['academy'])
def academy_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        academy_info = game.show_academy_info()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("ğŸ”„ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_check"))
        keyboard.add(InlineKeyboardButton("âš¡ Ğ£Ğ»ÑƒÑ‡ÑˆĞ¸Ñ‚ÑŒ", callback_data="academy_upgrade"))
        keyboard.add(InlineKeyboardButton("ğŸ‘¥ Ğ—Ğ°Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°", callback_data="academy_claim"))
        bot.send_message(message.chat.id, academy_info, reply_markup=keyboard)

# === ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ USERNAME ===
@bot.message_handler(func=lambda message: True)
def track_usernames(message):
    if message.from_user.username:
        user_usernames[message.chat.id] = message.from_user.username
        pvp_manager.save_pvp_data()

# === Ğ’Ğ•Ğ‘Ğ¥Ğ£Ğš Ğ˜ Ğ—ĞĞŸĞ£Ğ¡Ğš ===
@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
    return 'OK', 200

@app.route('/')
def index():
    return 'âš½ Football Manager Bot is running! ğŸ†'

def set_webhook():
    webhook_url = f"https://{os.environ.get('RENDER_SERVICE_NAME')}.onrender.com/webhook"
    bot.remove_webhook()
    bot.set_webhook(url=webhook_url)
    print(f"Webhook set to: {webhook_url}")

if __name__ == '__main__':
    set_webhook()
    app.run(host='0.0.0.0', port=5000)
