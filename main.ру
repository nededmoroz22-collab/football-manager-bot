from flask import Flask, request
import os
import telebot
import random
import json
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton

BOT_TOKEN = os.environ.get('BOT_TOKEN')
bot = telebot.TeleBot(BOT_TOKEN)
app = Flask(__name__)

# –ë–∞–∑–∞ —Ñ—É—Ç–±–æ–ª—å–Ω—ã—Ö –∫–ª—É–±–æ–≤
FOOTBALL_CLUBS = {
    "–†–µ–∞–ª –ú–∞–¥—Ä–∏–¥": {
        "players": [
            {"name": "–ë–µ–ª–ª–∏–Ω–≥–µ–º", "position": "–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫", "attack": 89, "defense": 72, "salary": 120000, "value": 180000000},
            {"name": "–í–∏–Ω–∏—Å–∏—É—Å", "position": "–ù–∞–ø–∞–¥–∞—é—â–∏–π", "attack": 88, "defense": 45, "salary": 110000, "value": 170000000},
            {"name": "–ö—É—Ä—Ç—É–∞", "position": "–í—Ä–∞—Ç–∞—Ä—å", "attack": 25, "defense": 90, "salary": 130000, "value": 60000000},
            {"name": "–ú–∏–ª–∏—Ç–∞–æ", "position": "–ó–∞—â–∏—Ç–Ω–∏–∫", "attack": 55, "defense": 84, "salary": 80000, "value": 40000000}
        ]
    },
    "–ë–∞—Ä—Å–µ–ª–æ–Ω–∞": {
        "players": [
            {"name": "–ü–µ–¥—Ä–∏", "position": "–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫", "attack": 87, "defense": 68, "salary": 100000, "value": 150000000},
            {"name": "–õ–µ–≤–∞–Ω–¥–æ–≤—Å–∫–∏", "position": "–ù–∞–ø–∞–¥–∞—é—â–∏–π", "attack": 86, "defense": 40, "salary": 120000, "value": 30000000},
            {"name": "–ê—Ä–∞—É—Ö–æ", "position": "–ó–∞—â–∏—Ç–Ω–∏–∫", "attack": 50, "defense": 86, "salary": 90000, "value": 70000000},
            {"name": "–¢–µ—Ä –®—Ç–µ–≥–µ–Ω", "position": "–í—Ä–∞—Ç–∞—Ä—å", "attack": 30, "defense": 88, "salary": 110000, "value": 35000000}
        ]
    },
    "–ú–∞–Ω –°–∏—Ç–∏": {
        "players": [
            {"name": "–•–æ–ª–∞–Ω–Ω", "position": "–ù–∞–ø–∞–¥–∞—é—â–∏–π", "attack": 91, "defense": 48, "salary": 150000, "value": 180000000},
            {"name": "–ì–≤–∞—Ä–¥–∏–æ–ª", "position": "–ó–∞—â–∏—Ç–Ω–∏–∫", "attack": 90, "defense": 65, "salary": 140000, "value": 60000000},
            {"name": "–†–æ–¥—Ä–∏", "position": "–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫", "attack": 82, "defense": 85, "salary": 120000, "value": 100000000},
            {"name": "–î–æ–Ω–Ω–∞—Ä—É–º–∞", "position": "–í—Ä–∞—Ç–∞—Ä—å", "attack": 35, "defense": 87, "salary": 100000, "value": 40000000}
        ]
    },
    "–õ–∏–≤–µ—Ä–ø—É–ª—å": {
        "players": [
            {"name": "–°–∞–ª–∞—Ö", "position": "–ù–∞–ø–∞–¥–∞—é—â–∏–π", "attack": 88, "defense": 50, "salary": 120000, "value": 65000000},
            {"name": "–í–∞–Ω –î–µ–π–∫", "position": "–ó–∞—â–∏—Ç–Ω–∏–∫", "attack": 55, "defense": 89, "salary": 110000, "value": 45000000},
            {"name": "–ò—Å–∞–∫", "position": "–ù–∞–ø–∞–¥–∞—é—â–∏–π", "attack": 88, "defense": 39, "salary": 100000, "value": 70000000},
            {"name": "–ê–ª–∏—Å—Å–æ–Ω", "position": "–í—Ä–∞—Ç–∞—Ä—å", "attack": 30, "defense": 89, "salary": 100000, "value": 45000000}
        ]
    },
    "–ë–∞–≤–∞—Ä–∏—è": {
        "players": [
            {"name": "–ö–µ–π–Ω", "position": "–ù–∞–ø–∞–¥–∞—é—â–∏–π", "attack": 90, "defense": 52, "salary": 130000, "value": 90000000},
            {"name": "–ö–∏–º–º–∏—Ö", "position": "–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫", "attack": 85, "defense": 80, "salary": 120000, "value": 75000000},
            {"name": "–ü–∞–≤–ª–æ–≤–∏—á", "position": "–ó–∞—â–∏—Ç–Ω–∏–∫", "attack": 57, "defense": 80, "salary": 100000, "value": 25000000},
            {"name": "–ù–æ–π–µ—Ä", "position": "–í—Ä–∞—Ç–∞—Ä—å", "attack": 40, "defense": 86, "salary": 90000, "value": 10000000}
        ]
    }
}

class AdvancedFootballManager:
    def __init__(self, user_id):
        self.user_id = user_id
        self.load_game()
        
        if not hasattr(self, 'points'):
            self.club_name = None
            self.points = 0
            self.money = 10000000
            self.week = 1
            self.players = []
            self.league_teams = [
                {"name": "–ú–µ—á—Ç–∞—Ç–µ–ª–∏ FC", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "–ì–ª–∞–¥–∏–∞—Ç–æ—Ä—ã", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "–¢–∏—Ç–∞–Ω—ã", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "–ë—É—Ä–µ–≤–µ—Å—Ç–Ω–∏–∫–∏", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "–ú–æ–ª–Ω–∏—è", "points": 0, "goals_for": 0, "goals_against": 0},
                {"name": "–§–µ–Ω–∏–∫—Å", "points": 0, "goals_for": 0, "goals_against": 0}
            ]
            # –°–∏—Å—Ç–µ–º–∞ –∞–∫–∞–¥–µ–º–∏–∏
            self.academy = {
                "level": 1,
                "training_cost": 500000,
                "next_refresh": 0,
                "current_player": None
            }
        
        self.generate_transfer_market()
    
    def save_game(self):
        game_data = {
            'club_name': self.club_name,
            'points': self.points,
            'money': self.money, 
            'week': self.week,
            'players': self.players,
            'league_teams': self.league_teams,
            'academy': self.academy
        }
        try:
            with open(f'/tmp/football_save_{self.user_id}.json', 'w') as f:
                json.dump(game_data, f)
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: {e}")
    
    def load_game(self):
        try:
            with open(f'/tmp/football_save_{self.user_id}.json', 'r') as f:
                game_data = json.load(f)
                self.club_name = game_data['club_name']
                self.points = game_data['points']
                self.money = game_data['money']
                self.week = game_data['week'] 
                self.players = game_data['players']
                self.league_teams = game_data['league_teams']
                self.academy = game_data['academy']
                print("‚úÖ –ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è")
        except Exception as e:
            print(f"‚ùå –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è, –Ω–æ–≤–∞—è –∏–≥—Ä–∞: {e}")
    
    def select_club(self, club_name):
        """–í—ã–±–æ—Ä –∫–ª—É–±–∞ –∏–≥—Ä–æ–∫–æ–º"""
        if club_name in FOOTBALL_CLUBS:
            self.club_name = club_name
            club_data = FOOTBALL_CLUBS[club_name]
            self.players = club_data['players'].copy()
            self.save_game()
            return f"‚úÖ –í—ã –≤—ã–±—Ä–∞–ª–∏: {club_name}!\n\n–¢–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º –∫–ª—É–±–æ–º –∫ –ø–æ–±–µ–¥–µ! üèÜ"
        return "‚ùå –ö–ª—É–± –Ω–µ –Ω–∞–π–¥–µ–Ω"
    
    def generate_transfer_market(self):
        positions = ["–ù–∞–ø–∞–¥–∞—é—â–∏–π", "–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫", "–ó–∞—â–∏—Ç–Ω–∏–∫", "–í—Ä–∞—Ç–∞—Ä—å"]
        names = ["–°–æ–∫–æ–ª–æ–≤", "–û—Ä–ª–æ–≤", "–õ–µ–±–µ–¥–µ–≤", "–ú–µ–¥–≤–µ–¥–µ–≤", "–í–æ–ª–∫–æ–≤", "–°–æ–ª–æ–≤—å–µ–≤", "–ú–æ—Ä–æ–∑–æ–≤", "–ó–∞–π—Ü–µ–≤"]
        
        self.transfer_players = []
        for _ in range(6):
            position = random.choice(positions)
            attack = random.randint(70, 88)
            defense = random.randint(65, 85)
            price = random.randint(1000000, 3000000)
            
            player = {
                "name": random.choice(names),
                "position": position,
                "attack": attack,
                "defense": defense,
                "price": price,
                "country": random.choice(["üá∑üá∫ –†–æ—Å—Å–∏—è", "üáßüá∑ –ë—Ä–∞–∑–∏–ª–∏—è", "üá¶üá∑ –ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", "üá´üá∑ –§—Ä–∞–Ω—Ü–∏—è", "üá©üá™ –ì–µ—Ä–º–∞–Ω–∏—è"])
            }
            self.transfer_players.append(player)
    
    def calculate_team_power(self):
        if not self.players:
            return 50
        total_power = sum(p["attack"] + p["defense"] for p in self.players)
        return total_power / len(self.players)
    
    def play_match(self):
        team_power = self.calculate_team_power()
        opponent_index = (self.week - 1) % (len(self.league_teams) - 1)
        opponent = self.league_teams[opponent_index + 1]
        
        opponent_power = 60 + (self.week * 2) + random.randint(-10, 10)
        
        power_diff = team_power - opponent_power
        my_goals = max(0, int(1 + (power_diff / 20) + random.randint(0, 2)))
        opponent_goals = max(0, int(1 + (-power_diff / 20) + random.randint(0, 2)))
        
        self.league_teams[0]["goals_for"] += my_goals
        self.league_teams[0]["goals_against"] += opponent_goals
        opponent["goals_for"] += opponent_goals
        opponent["goals_against"] += my_goals
        
        if my_goals > opponent_goals:
            result = f"–ü–û–ë–ï–î–ê {my_goals}-{opponent_goals}! üéâ"
            self.points += 3
            self.league_teams[0]["points"] += 3
            prize = 250000
        elif my_goals == opponent_goals:
            result = f"–ù–ò–ß–¨–Ø {my_goals}-{opponent_goals} ü§ù"
            self.points += 1
            self.league_teams[0]["points"] += 1
            opponent["points"] += 1
            prize = 120000
        else:
            result = f"–ü–û–†–ê–ñ–ï–ù–ò–ï {my_goals}-{opponent_goals} üòî"
            opponent["points"] += 3
            prize = 60000
        
        self.money += prize
        self.week += 1
        
        salary_info = ""
        if self.week % 4 == 0:
            total_salary = sum(p["salary"] for p in self.players)
            self.money -= total_salary
            salary_info = f"\nüí∏ –ó–∞—Ä–ø–ª–∞—Ç—ã: -{total_salary:,}‚Ç¨"
        
        self.save_game()
        return f"üéØ –ù–µ–¥–µ–ª—è {self.week-1}\n‚öîÔ∏è –ü—Ä–æ—Ç–∏–≤: {opponent['name']}\n{result}\nüí∞ –ü—Ä–∏–∑: +{prize:,}‚Ç¨{salary_info}\nüèÜ –û—á–∫–æ–≤: {self.points}\nüíµ –ë—é–¥–∂–µ—Ç: {self.money:,}‚Ç¨"
    
    def show_league_table(self):
        sorted_teams = sorted(self.league_teams, key=lambda x: (-x["points"], -(x["goals_for"] - x["goals_against"])))
        
        table = "üèÜ –¢–ê–ë–õ–ò–¶–ê –õ–ò–ì–ò:\n\n"
        table += "‚Ññ  –ö–æ–º–∞–Ω–¥–∞           –û  –ì–ó  –ì–ü  –†\n"
        table += "‚îÄ" * 30 + "\n"
        
        for i, team in enumerate(sorted_teams, 1):
            goals_diff = team["goals_for"] - team["goals_against"]
            goals_diff_str = f"+{goals_diff}" if goals_diff > 0 else str(goals_diff)
            emoji = "ü•á" if i == 1 else "ü•à" if i == 2 else "ü•â" if i == 3 else "  "
            table += f"{i:<2}{emoji} {team['name']:<15} {team['points']:<2} {team['goals_for']:<2} {team['goals_against']:<2} {goals_diff_str:<3}\n"
        
        table += f"\nüìÖ –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è: {self.week}"
        return table
    
    def show_transfer_market(self):
        if not self.transfer_players:
            self.generate_transfer_market()
        
        market = "üõí –¢–†–ê–ù–°–§–ï–†–ù–´–ô –†–´–ù–û–ö:\n\n"
        for i, player in enumerate(self.transfer_players, 1):
            stars = "‚≠ê" * (player["attack"] // 20)
            market += f"{i}. {player['name']} {player['country']}\n"
            market += f"   üìç {player['position']} | ‚öîÔ∏è{player['attack']} üõ°Ô∏è{player['defense']}\n"
            market += f"   {stars}\n"
            market += f"   üí∞ {player['price']:,}‚Ç¨\n\n"
        
        market += "üõí –ö–æ–º–∞–Ω–¥—ã:\n/buy [–Ω–æ–º–µ—Ä] - –ö—É–ø–∏—Ç—å –∏–≥—Ä–æ–∫–∞\n/sell [–Ω–æ–º–µ—Ä] - –ü—Ä–æ–¥–∞—Ç—å –∏–≥—Ä–æ–∫–∞\n/refresh - –û–±–Ω–æ–≤–∏—Ç—å —Ä—ã–Ω–æ–∫"
        return market
    
    def buy_player(self, player_num):
        try:
            player_index = int(player_num) - 1
            if player_index < 0 or player_index >= len(self.transfer_players):
                return "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞!"
            
            player = self.transfer_players[player_index]
            
            if self.money < player["price"]:
                return f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥! –ù—É–∂–Ω–æ {player['price']:,}‚Ç¨"
            
            if len(self.players) >= 8:
                return "‚ùå –í –∫–æ–º–∞–Ω–¥–µ –º–∞–∫—Å–∏–º—É–º 8 –∏–≥—Ä–æ–∫–æ–≤! –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π –∫–æ–≥–æ-—Ç–æ."
            
            new_player = player.copy()
            new_player["salary"] = player["price"] // 20
            new_player["value"] = player["price"]
            self.players.append(new_player)
            
            self.money -= player["price"]
            self.transfer_players.pop(player_index)
            
            self.save_game()
            return f"‚úÖ –£–°–ü–ï–®–ù–ê–Ø –ü–û–ö–£–ü–ö–ê!\nüë§ {new_player['name']} ({new_player['position']})\n‚≠ê ‚öîÔ∏è{new_player['attack']} üõ°Ô∏è{new_player['defense']}\nüíµ –¶–µ–Ω–∞: {player['price']:,}‚Ç¨\nüí∞ –û—Å—Ç–∞–ª–æ—Å—å: {self.money:,}‚Ç¨"
        
        except ValueError:
            return "‚ùå –ò—Å–ø–æ–ª—å–∑—É–π: /buy [–Ω–æ–º–µ—Ä]"
    
    def sell_player(self, player_num):
        try:
            player_index = int(player_num) - 1
            if player_index < 0 or player_index >= len(self.players):
                return "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∏–≥—Ä–æ–∫–∞!"
            
            if len(self.players) <= 4:
                return "‚ùå –í –∫–æ–º–∞–Ω–¥–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 4 –∏–≥—Ä–æ–∫–∞!"
            
            player = self.players[player_index]
            sell_price = player["value"] * 0.8
            
            self.money += sell_price
            self.players.pop(player_index)
            
            self.save_game()
            return f"‚úÖ –ò–ì–†–û–ö –ü–†–û–î–ê–ù!\nüë§ {player['name']} ({player['position']})\nüíµ –ü–æ–ª—É—á–µ–Ω–æ: {sell_price:,.0f}‚Ç¨\nüí∞ –ë—é–¥–∂–µ—Ç: {self.money:,}‚Ç¨"
        
        except ValueError:
            return "‚ùå –ò—Å–ø–æ–ª—å–∑—É–π: /sell [–Ω–æ–º–µ—Ä]"
    
    def refresh_market(self):
        self.generate_transfer_market()
        return "üîÉ –¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω—ã–π —Ä—ã–Ω–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω! –ù–æ–≤—ã–µ –∏–≥—Ä–æ–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã!"
    
    def generate_youth_player(self):
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –º–æ–ª–æ–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è –∞–∫–∞–¥–µ–º–∏–∏"""
        level = self.academy["level"]
        positions = ["–ù–∞–ø–∞–¥–∞—é—â–∏–π", "–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫", "–ó–∞—â–∏—Ç–Ω–∏–∫", "–í—Ä–∞—Ç–∞—Ä—å"]
        names = ["–ù–æ–≤–∏–∫–æ–≤", "–ú–æ–ª–æ–¥—Ü–æ–≤", "–¢–∞–ª–∞–Ω—Ç–æ–≤", "–ë—É–¥—É—â–∏–π", "–ó–≤–µ–∑–¥–æ–≤", "–ù–∞–¥–µ–∂–¥–∏–Ω"]
        
        # –°–∏–ª–∞ –∏–≥—Ä–æ–∫–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –∞–∫–∞–¥–µ–º–∏–∏
        min_power = 60 + (level - 1) * 5
        max_power = 70 + (level - 1) * 5
        
        position = random.choice(positions)
        if position == "–ù–∞–ø–∞–¥–∞—é—â–∏–π":
            attack = random.randint(min_power, max_power)
            defense = random.randint(30, 50)
        elif position == "–ü–æ–ª—É–∑–∞—â–∏—Ç–Ω–∏–∫":
            attack = random.randint(min_power - 5, max_power - 5)
            defense = random.randint(min_power - 10, max_power - 10)
        elif position == "–ó–∞—â–∏—Ç–Ω–∏–∫":
            attack = random.randint(40, 60)
            defense = random.randint(min_power, max_power)
        else:  # –í—Ä–∞—Ç–∞—Ä—å
            attack = random.randint(20, 40)
            defense = random.randint(min_power, max_power)
        
        player = {
            "name": f"{random.choice(names)}-–º–ª.",
            "position": position,
            "attack": attack,
            "defense": defense,
            "salary": 10000 * level,
            "value": 500000 * level,
            "from_academy": True
        }
        
        return player
    
    def upgrade_academy(self):
        """–£–ª—É—á—à–µ–Ω–∏–µ –∞–∫–∞–¥–µ–º–∏–∏"""
        current_level = self.academy["level"]
        if current_level >= 5:
            return "‚ùå –ê–∫–∞–¥–µ–º–∏—è —É–∂–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è! üèÜ"
        
        cost = self.academy["training_cost"]
        if self.money < cost:
            return f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥! –ù—É–∂–Ω–æ {cost:,}‚Ç¨"
        
        self.money -= cost
        self.academy["level"] += 1
        self.academy["training_cost"] *= 2
        
        self.save_game()
        return f"‚úÖ –ê–∫–∞–¥–µ–º–∏—è —É–ª—É—á—à–µ–Ω–∞ –¥–æ —É—Ä–æ–≤–Ω—è {self.academy['level']}!\nüí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {cost:,}‚Ç¨\nüíµ –û—Å—Ç–∞–ª–æ—Å—å: {self.money:,}‚Ç¨"
    
    def get_academy_player(self):
        """–ü–æ–ª—É—á–∏—Ç—å –∏–≥—Ä–æ–∫–∞ –∏–∑ –∞–∫–∞–¥–µ–º–∏–∏"""
        if self.academy["current_player"] is None:
            if self.week >= self.academy["next_refresh"]:
                self.academy["current_player"] = self.generate_youth_player()
                self.academy["next_refresh"] = self.week + 5
                self.save_game()
                return "üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–æ–≤—ã–π –º–æ–ª–æ–¥–æ–π –∏–≥—Ä–æ–∫! –ù–∞–∂–º–∏—Ç–µ 'üë• –ó–∞–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞'"
            else:
                weeks_left = self.academy["next_refresh"] - self.week
                return f"‚è≥ –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ {weeks_left} –Ω–µ–¥–µ–ª—å"
        
        return "‚úÖ –ï—Å—Ç—å –∏–≥—Ä–æ–∫ –≤ –∞–∫–∞–¥–µ–º–∏–∏! –ù–∞–∂–º–∏—Ç–µ 'üë• –ó–∞–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞'"
    
    def claim_academy_player(self):
        """–ó–∞–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞ –∏–∑ –∞–∫–∞–¥–µ–º–∏–∏ –≤ –æ—Å–Ω–æ–≤–Ω—É—é –∫–æ–º–∞–Ω–¥—É"""
        if self.academy["current_player"] is None:
            return "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –≤ –∞–∫–∞–¥–µ–º–∏–∏"
        
        if len(self.players) >= 8:
            return "‚ùå –í –∫–æ–º–∞–Ω–¥–µ –º–∞–∫—Å–∏–º—É–º 8 –∏–≥—Ä–æ–∫–æ–≤! –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–¥–∞–π—Ç–µ –∫–æ–≥–æ-—Ç–æ."
        
        player = self.academy["current_player"]
        self.players.append(player)
        self.academy["current_player"] = None
        
        self.save_game()
        return f"‚úÖ –ò–≥—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–º–∞–Ω–¥—É!\nüë§ {player['name']} ({player['position']})\n‚≠ê ‚öîÔ∏è{player['attack']} üõ°Ô∏è{player['defense']}"
    
    def show_academy_info(self):
        """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫–∞–¥–µ–º–∏–∏"""
        academy_info = f"üè´ –ê–ö–ê–î–ï–ú–ò–Ø [–£—Ä. {self.academy['level']}/5]\n\n"
        
        levels = {
            1: "üîπ –ù–∞—á–∏–Ω–∞—é—â–∞—è (60-70 —Å–∏–ª—ã)",
            2: "üî∏ –†–∞–∑–≤–∏–≤–∞—é—â–∞—è (65-75 —Å–∏–ª—ã)", 
            3: "üî∫ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è (70-80 —Å–∏–ª—ã)",
            4: "üèÖ –≠–ª–∏—Ç–Ω–∞—è (75-85 —Å–∏–ª—ã)",
            5: "‚≠ê –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è (80-90 —Å–∏–ª—ã)"
        }
        
        academy_info += f"{levels[self.academy['level']]}\n"
        academy_info += f"üí∞ –°–ª–µ–¥—É—é—â–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ: {self.academy['training_cost']:,}‚Ç¨\n\n"
        
        if self.academy["current_player"]:
            player = self.academy["current_player"]
            academy_info += f"üë• –î–æ—Å—Ç—É–ø–µ–Ω –∏–≥—Ä–æ–∫:\n"
            academy_info += f"üë§ {player['name']} ({player['position']})\n"
            academy_info += f"‚≠ê ‚öîÔ∏è{player['attack']} üõ°Ô∏è{player['defense']}\n"
        else:
            if self.week >= self.academy["next_refresh"]:
                academy_info += "üîÑ –î–æ—Å—Ç—É–ø–µ–Ω –Ω–æ–≤—ã–π –∏–≥—Ä–æ–∫!\n"
            else:
                weeks_left = self.academy["next_refresh"] - self.week
                academy_info += f"‚è≥ –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ —á–µ—Ä–µ–∑ {weeks_left} –Ω–µ–¥–µ–ª—å\n"
        
        return academy_info

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_games = {}

def get_user_game(user_id):
    if user_id not in user_games:
        user_games[user_id] = AdvancedFootballManager(user_id)
    return user_games[user_id]

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ —Å –∏–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∞–º–∏
@bot.message_handler(commands=['start'])
def start_command(message):
    game = get_user_game(message.chat.id)
    
    if game.club_name is None:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–ª—É–±–∞
        keyboard = InlineKeyboardMarkup()
        clubs = list(FOOTBALL_CLUBS.keys())
        
        for i in range(0, len(clubs), 2):
            row = []
            row.append(InlineKeyboardButton(clubs[i], callback_data=f"club_{clubs[i]}"))
            if i + 1 < len(clubs):
                row.append(InlineKeyboardButton(clubs[i+1], callback_data=f"club_{clubs[i+1]}"))
            keyboard.add(*row)
        
        bot.send_message(message.chat.id, 
            "‚öΩ –î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨ –í –§–£–¢–ë–û–õ–¨–ù–´–ô –ú–ï–ù–ï–î–ñ–ï–† 2025! üèÜ\n\n"
            "–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–π –∫–ª—É–±:",
            reply_markup=keyboard)
    else:
        show_main_menu(message.chat.id, game)

def show_main_menu(chat_id, game):
    keyboard = InlineKeyboardMarkup()
    keyboard.add(InlineKeyboardButton("üë• –ú–æ—è –∫–æ–º–∞–Ω–¥–∞", callback_data="menu_team"))
    keyboard.add(InlineKeyboardButton("‚öΩ –°—ã–≥—Ä–∞—Ç—å –º–∞—Ç—á", callback_data="menu_play"))
    keyboard.add(InlineKeyboardButton("üèÜ –¢–∞–±–ª–∏—Ü–∞ –ª–∏–≥–∏", callback_data="menu_table"))
    keyboard.add(InlineKeyboardButton("üõí –¢—Ä–∞–Ω—Å—Ñ–µ—Ä–Ω—ã–π —Ä—ã–Ω–æ–∫", callback_data="menu_market"))
    keyboard.add(InlineKeyboardButton("üè´ –ê–∫–∞–¥–µ–º–∏—è", callback_data="menu_academy"))
    keyboard.add(InlineKeyboardButton("üíµ –§–∏–Ω–∞–Ω—Å—ã", callback_data="menu_money"))
    
    bot.send_message(chat_id,
        f"üèÜ {game.club_name}\n"
        f"üíµ –ë—é–¥–∂–µ—Ç: {game.money:,}‚Ç¨\n"
        f"üèÖ –û—á–∫–æ–≤: {game.points}\n"
        f"üìÖ –ù–µ–¥–µ–ª—è: {game.week}\n\n"
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=keyboard)

@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    game = get_user_game(call.message.chat.id)
    
    if call.data.startswith("club_"):
        club_name = call.data[5:]
        result = game.select_club(club_name)
        bot.edit_message_text(
            f"{result}\n\n–¢–µ–ø–µ—Ä—å –≤—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ {club_name}! üéâ",
            call.message.chat.id,
            call.message.message_id
        )
        show_main_menu(call.message.chat.id, game)
    
    elif call.data == "menu_team":
        team_info = f"üèÜ {game.club_name}\nüí∞ –ë—é–¥–∂–µ—Ç: {game.money:,}‚Ç¨\nüèÖ –û—á–∫–æ–≤: {game.points}\n‚≠ê –°–∏–ª–∞: {game.calculate_team_power():.1f}\n\n"
        team_info += "üë• –°–æ—Å—Ç–∞–≤:\n"
        for i, player in enumerate(game.players, 1):
            team_info += f"{i}. {player['name']} ({player['position']})\n"
            team_info += f"   ‚öîÔ∏è{player['attack']} üõ°Ô∏è{player['defense']} üí∞{player['salary']:,}‚Ç¨\n"
        
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        
        bot.edit_message_text(team_info, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "menu_play":
        result = game.play_match()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(result, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "menu_table":
        table = game.show_league_table()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(table, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "menu_market":
        market = game.show_transfer_market()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ä—ã–Ω–æ–∫", callback_data="market_refresh"))
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(market, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "menu_academy":
        academy_info = game.show_academy_info()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_check"))
        keyboard.add(InlineKeyboardButton("‚ö° –£–ª—É—á—à–∏—Ç—å", callback_data="academy_upgrade"))
        keyboard.add(InlineKeyboardButton("üë• –ó–∞–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_claim"))
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(academy_info, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "menu_money":
        stats = f"üíµ –ë—é–¥–∂–µ—Ç: {game.money:,}‚Ç¨\nüèÖ –û—á–∫–æ–≤: {game.points}\nüìÖ –ù–µ–¥–µ–ª—è: {game.week}"
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(stats, call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "menu_back":
        show_main_menu(call.message.chat.id, game)
    
    elif call.data == "market_refresh":
        result = game.refresh_market()
        market = game.show_transfer_market()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ä—ã–Ω–æ–∫", callback_data="market_refresh"))
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(f"{result}\n\n{market}", call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "academy_check":
        result = game.get_academy_player()
        academy_info = game.show_academy_info()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_check"))
        keyboard.add(InlineKeyboardButton("‚ö° –£–ª—É—á—à–∏—Ç—å", callback_data="academy_upgrade"))
        keyboard.add(InlineKeyboardButton("üë• –ó–∞–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_claim"))
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(f"{result}\n\n{academy_info}", call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "academy_upgrade":
        result = game.upgrade_academy()
        academy_info = game.show_academy_info()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_check"))
        keyboard.add(InlineKeyboardButton("‚ö° –£–ª—É—á—à–∏—Ç—å", callback_data="academy_upgrade"))
        keyboard.add(InlineKeyboardButton("üë• –ó–∞–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_claim"))
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(f"{result}\n\n{academy_info}", call.message.chat.id, call.message.message_id, reply_markup=keyboard)
    
    elif call.data == "academy_claim":
        result = game.claim_academy_player()
        academy_info = game.show_academy_info()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_check"))
        keyboard.add(InlineKeyboardButton("‚ö° –£–ª—É—á—à–∏—Ç—å", callback_data="academy_upgrade"))
        keyboard.add(InlineKeyboardButton("üë• –ó–∞–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_claim"))
        keyboard.add(InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="menu_back"))
        bot.edit_message_text(f"{result}\n\n{academy_info}", call.message.chat.id, call.message.message_id, reply_markup=keyboard)

# –°—Ç–∞—Ä—ã–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –∫–æ–º–∞–Ω–¥—ã (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
@bot.message_handler(commands=['team'])
def team_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        team_info = f"üèÜ {game.club_name}\nüí∞ –ë—é–¥–∂–µ—Ç: {game.money:,}‚Ç¨\nüèÖ –û—á–∫–æ–≤: {game.points}\n‚≠ê –°–∏–ª–∞: {game.calculate_team_power():.1f}\n\n"
        team_info += "üë• –°–æ—Å—Ç–∞–≤:\n"
        for i, player in enumerate(game.players, 1):
            team_info += f"{i}. {player['name']} ({player['position']})\n"
            team_info += f"   ‚öîÔ∏è{player['attack']} üõ°Ô∏è{player['defense']} üí∞{player['salary']:,}‚Ç¨\n"
        bot.send_message(message.chat.id, team_info)

@bot.message_handler(commands=['play'])
def play_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, game.play_match())

@bot.message_handler(commands=['table'])
def table_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, game.show_league_table())

@bot.message_handler(commands=['market'])
def market_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, game.show_transfer_market())

@bot.message_handler(commands=['buy'])
def buy_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        parts = message.text.split()
        if len(parts) == 2:
            bot.send_message(message.chat.id, game.buy_player(parts[1]))
        else:
            bot.send_message(message.chat.id, "–ò—Å–ø–æ–ª—å–∑—É–π: /buy [–Ω–æ–º–µ—Ä]")

@bot.message_handler(commands=['sell'])
def sell_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        parts = message.text.split()
        if len(parts) == 2:
            bot.send_message(message.chat.id, game.sell_player(parts[1]))
        else:
            bot.send_message(message.chat.id, "–ò—Å–ø–æ–ª—å–∑—É–π: /sell [–Ω–æ–º–µ—Ä]")

@bot.message_handler(commands=['refresh'])
def refresh_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, game.refresh_market())

@bot.message_handler(commands=['money', 'points'])
def money_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        bot.send_message(message.chat.id, f"üíµ –ë—é–¥–∂–µ—Ç: {game.money:,}‚Ç¨\nüèÖ –û—á–∫–æ–≤: {game.points}\nüìÖ –ù–µ–¥–µ–ª—è: {game.week}")

@bot.message_handler(commands=['academy'])
def academy_command(message):
    game = get_user_game(message.chat.id)
    if game.club_name is None:
        start_command(message)
    else:
        academy_info = game.show_academy_info()
        keyboard = InlineKeyboardMarkup()
        keyboard.add(InlineKeyboardButton("üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_check"))
        keyboard.add(InlineKeyboardButton("‚ö° –£–ª—É—á—à–∏—Ç—å", callback_data="academy_upgrade"))
        keyboard.add(InlineKeyboardButton("üë• –ó–∞–±—Ä–∞—Ç—å –∏–≥—Ä–æ–∫–∞", callback_data="academy_claim"))
        bot.send_message(message.chat.id, academy_info, reply_markup=keyboard)

# –í–µ–±—Ö—É–∫ –∏ –∑–∞–ø—É—Å–∫
@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
    return 'OK', 200

@app.route('/')
def index():
    return '‚öΩ Football Manager Bot is running! üèÜ'

def set_webhook():
    webhook_url = f"https://{os.environ.get('RENDER_SERVICE_NAME')}.onrender.com/webhook"
    bot.remove_webhook()
    bot.set_webhook(url=webhook_url)
    print(f"Webhook set to: {webhook_url}")

if __name__ == '__main__':
    set_webhook()
    app.run(host='0.0.0.0', port=5000)    
