player = {
                "name": random.choice(names),
                "position": position,
                "attack": attack,
                "defense": defense,
                "price": price,
                "country": random.choice(["ğŸ‡·ğŸ‡º Ğ Ğ¾ÑÑĞ¸Ñ", "ğŸ‡§ğŸ‡· Ğ‘Ñ€Ğ°Ğ·Ğ¸Ğ»Ğ¸Ñ", "ğŸ‡¦ğŸ‡· ĞÑ€Ğ³ĞµĞ½Ñ‚Ğ¸Ğ½Ğ°", "ğŸ‡«ğŸ‡· Ğ¤Ñ€Ğ°Ğ½Ñ†Ğ¸Ñ", "ğŸ‡©ğŸ‡ª Ğ“ĞµÑ€Ğ¼Ğ°Ğ½Ğ¸Ñ"])
            }
            self.transfer_players.append(player)
    
    def calculate_team_power(self):
        if not self.players:
            return 50
        total_power = sum(p["attack"] + p["defense"] for p in self.players)
        return total_power / len(self.players)
    
    def play_match(self):
        team_power = self.calculate_team_power()
        opponent_index = (self.week - 1) % (len(self.league_teams) - 1)
        opponent = self.league_teams[opponent_index + 1]
        
        opponent_power = 60 + (self.week * 2) + random.randint(-10, 10)
        
        power_diff = team_power - opponent_power
        my_goals = max(0, int(1 + (power_diff / 20) + random.randint(0, 2)))
        opponent_goals = max(0, int(1 + (-power_diff / 20) + random.randint(0, 2)))
        
        self.league_teams[0]["goals_for"] += my_goals
        self.league_teams[0]["goals_against"] += opponent_goals
        opponent["goals_for"] += opponent_goals
        opponent["goals_against"] += my_goals
        
        if my_goals > opponent_goals:
            result = f"ĞŸĞĞ‘Ğ•Ğ”Ğ {my_goals}-{opponent_goals}! ğŸ‰"
            self.points += 3
            self.league_teams[0]["points"] += 3
            prize = 250000
        elif my_goals == opponent_goals:
            result = f"ĞĞ˜Ğ§Ğ¬Ğ¯ {my_goals}-{opponent_goals} ğŸ¤"
            self.points += 1
            self.league_teams[0]["points"] += 1
            opponent["points"] += 1
            prize = 120000
        else:
            result = f"ĞŸĞĞ ĞĞ–Ğ•ĞĞ˜Ğ• {my_goals}-{opponent_goals} ğŸ˜”"
            opponent["points"] += 3


@bot.message_handler(commands=['start'])
def start_command(message):
    bot.send_message(message.chat.id,
        "âš½ Ğ¤Ğ£Ğ¢Ğ‘ĞĞ›Ğ¬ĞĞ«Ğ™ ĞœĞ•ĞĞ•Ğ”Ğ–Ğ•Ğ  ĞŸĞ Ğ-Ğ›Ğ˜Ğ“Ğ! ğŸ†\n\n"
        "ğŸ® ĞĞ¡ĞĞĞ’ĞĞ«Ğ• ĞšĞĞœĞĞĞ”Ğ«:\n"
        "/team - ĞœĞ¾Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°\n"
        "/play - Ğ¡Ñ‹Ğ³Ñ€Ğ°Ñ‚ÑŒ Ğ¼Ğ°Ñ‚Ñ‡\n"
        "/table - Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ»Ğ¸Ğ³Ğ¸\n\n"
        "ğŸ›’ Ğ¢Ğ ĞĞĞ¡Ğ¤Ğ•Ğ Ğ«:\n"
        "/market - Ğ¢Ñ€Ğ°Ğ½ÑÑ„ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ€Ñ‹Ğ½Ğ¾Ğº\n"
        "/buy [N] - ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°\n"
        "/sell [N] - ĞŸÑ€Ğ¾Ğ´Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°\n"
        "/refresh - ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ñ‹Ğ½Ğ¾Ğº\n\n"
        "ğŸ’¼ Ğ¤Ğ˜ĞĞĞĞ¡Ğ«:\n"
        "/money - Ğ‘ÑĞ´Ğ¶ĞµÑ‚\n"
        "/points - Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°"
    )

@bot.message_handler(commands=['play'])
def play_match(message):
    bot.send_message(message.chat.id, game.play_match())

@bot.message_handler(commands=['team'])
def show_team(message):
    team_info = f"ğŸ† ĞœĞµÑ‡Ñ‚Ğ°Ñ‚ĞµĞ»Ğ¸ FC\nğŸ’° Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {game.money:,}â‚¬\nğŸ… ĞÑ‡ĞºĞ¾Ğ²: {game.points}\nâ­ Ğ¡Ğ¸Ğ»Ğ°: {game.calculate_team_power():.1f}\n\n"
    team_info += "ğŸ‘¥ Ğ¡Ğ¾ÑÑ‚Ğ°Ğ²:\n"
    for i, player in enumerate(game.players, 1):
        team_info += f"{i}. {player['name']} ({player['position']})\n"
        team_info += f"   âš”ï¸{player['attack']} ğŸ›¡ï¸{player['defense']} ğŸ’°{player['salary']:,}â‚¬\n"
    bot.send_message(message.chat.id, team_info)

@bot.message_handler(commands=['table'])
def show_table(message):
    bot.send_message(message.chat.id, game.show_league_table())

@bot.message_handler(commands=['market'])
def show_market(message):
    bot.send_message(message.chat.id, game.show_transfer_market())

@bot.message_handler(commands=['buy'])
def buy_player(message):
    parts = message.text.split()
    if len(parts) == 2:
        bot.send_message(message.chat.id, game.buy_player(parts[1]))
    else:
        bot.send_message(message.chat.id, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: /buy [Ğ½Ğ¾Ğ¼ĞµÑ€]")

@bot.message_handler(commands=['sell'])
def sell_player(message):
    parts = message.text.split()
    if len(parts) == 2:
        bot.send_message(message.chat.id, game.sell_player(parts[1]))
    else:
        bot.send_message(message.chat.id, "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: /sell [Ğ½Ğ¾Ğ¼ĞµÑ€]")

@bot.message_handler(commands=['refresh'])
def refresh_market(message):
    bot.send_message(message.chat.id, game.refresh_market())

@bot.message_handler(commands=['money', 'points'])
def show_stats(message):
    bot.send_message(message.chat.id, f"ğŸ’µ Ğ‘ÑĞ´Ğ¶ĞµÑ‚: {game.money:,}â‚¬\nğŸ… ĞÑ‡ĞºĞ¾Ğ²: {game.points}\nğŸ“… ĞĞµĞ´ĞµĞ»Ñ: {game.week}")

@app.route('/webhook', methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
    return 'OK', 200

@app.route('/')
def index():
    return 'âš½ Football Manager Bot is running! ğŸ†'

def set_webhook():
    webhook_url = f"https://{os.environ.get('RENDER_SERVICE_NAME')}.onrender.com/webhook"
    bot.remove_webhook()
    bot.set_webhook(url=webhook_url)
    print(f"Webhook set to: {webhook_url}")

if __name__ == '__main__':
    set_webhook()
    app.run(host='0.0.0.0', port=5000)

            
